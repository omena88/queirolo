<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-_8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carga de Movimientos Bancarios</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
      --color-principal: #1b8943;      /* Verde corporativo */
      --color-principal-hover: #157235; /* Verde más oscuro */
      --color-secundario: #a98f43;     /* Dorado/Marrón corporativo */
      --color-secundario-hover: #8f7a39; /* Dorado más oscuro */
      --color-success: #2ecc71;        /* Verde éxito */
      --color-warning: #e67e22;        /* Naranja advertencia */
      --color-danger: #e74c3c;         /* Rojo peligro */
      --color-fondo: #f5f5f5;          /* Fondo general más oscuro */
      --color-superficie: #ffffff;     /* Blanco para tarjetas */
      --color-superficie-alt: #edf2ed; /* Fondo alternativo con tono verde suave */
      --color-superficie-sec: #f5f2e6; /* Fondo alternativo con tono dorado suave */
      --color-texto: #333333;          /* Texto principal casi negro */
      --color-texto-secundario: #666666; /* Texto secundario gris oscuro */
      --color-texto-claro: #ffffff;    /* Texto claro/blanco */
      --color-borde: #e0e0e0;          /* Borde claro */
      --color-borde-enfasis: #cccccc;  /* Borde con énfasis */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.1);
      --shadow-md: 0 2px 4px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-lg: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
      --border-radius-sm: 4px;
      --border-radius: 6px;
      --border-radius-lg: 8px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 24px;
      --spacing-xxl: 32px;
      font-size: 16px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: var(--color-fondo);
      color: var(--color-texto);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }

    .reporte-container {
      max-width: 100%;
      width: 1380px;
      margin: 0 auto;
      padding: var(--spacing-lg);
      box-sizing: border-box;
    }

    .titulo-reporte {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-xl);
    }
    
    .titulo-reporte h1 {
      color: var(--color-texto);
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .titulo-reporte h1 i {
      color: var(--color-principal);
    }

    .config-step {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      background-color: var(--color-superficie);
      border: 1px solid var(--color-borde);
      position: relative;
      margin-bottom: var(--spacing-xl); /* Added for spacing */
    }
    
    .config-step:hover {
      box-shadow: var(--shadow-sm);
      border-color: var(--color-borde-enfasis);
    }
    
    .step-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-sm);
    }
    
    .step-number {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 30px; /* Adjusted size */
      height: 30px; /* Adjusted size */
      background-color: var(--color-principal);
      color: var(--color-texto-claro);
      font-weight: 600;
      font-size: 14px;
      border-radius: 50%; /* Circular */
    }
    
    .step-header h4 {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
      color: var(--color-texto);
    }
    
    .step-content {
      padding-left: 0; /* Remove left padding for grid layout */
    }
     .config-controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      width: 100%;
    }
    .btn {
      background-color: var(--color-principal);
      color: white;
      border: none;
      padding: 8px var(--spacing-md);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-family: inherit;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      white-space: nowrap;
      box-shadow: var(--shadow-sm);
    }
    
    .btn:hover:not(:disabled) {
      background-color: var(--color-principal-hover);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    
    .btn:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }
    
    .btn:disabled {
      background-color: var(--color-texto-secundario);
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: none;
    }
    
    .btn i {
      font-size: 13px;
    }

    .seccion {
      margin-bottom: var(--spacing-xl);
    }
        
    .reporte-ventas-container, /* Reuse for consistency */
    .reporte-inferior-grid > div { /* Reuse for consistency */
      background-color: var(--color-superficie);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.3s ease;
      overflow: hidden;
      border: 1px solid var(--color-borde);
      max-width: 100%;
    }
    
    .reporte-ventas-container:hover,
    .reporte-inferior-grid > div:hover {
      box-shadow: var(--shadow-md);
    }

    .reporte-tabla-container {
      width: 100%;
      position: relative;
      overflow: auto; /* Changed to auto for horizontal scroll if needed */
    }
    
    .tabla-header {
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--color-borde);
      background-color: var(--color-superficie);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .tabla-header h3 {
      font-size: 15px;
      font-weight: 600;
      color: var(--color-texto);
      margin: 0;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .tabla-header h3 i {
      color: var(--color-principal);
    }
    
    .tabla-body {
      padding: 0; /* Removed padding as table itself will have it or cells */
      overflow: hidden;
    }

    .reporte-tabla {
      width: 100% !important;
      max-width: none !important;
      border-collapse: separate; 
      border-spacing: 0;
      margin: 0;
      table-layout: auto; 
      position: relative;
      border-radius: var(--border-radius); 
      overflow: hidden;
    }
    
    .reporte-tabla th {
      background-color: var(--color-superficie-alt);
      color: var(--color-texto);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      font-size: 12px;
      white-space: normal; 
      word-wrap: break-word;
      hyphens: auto;
      vertical-align: middle;
      height: auto;
      min-height: 50px;
      text-align: left; /* Default for th */
      padding: 10px 8px;
      border-bottom: 1px solid var(--color-borde);
    }
    
    .reporte-tabla td {
      white-space: nowrap;
      text-align: left; /* Default for td */
      padding: 10px 8px;
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      border-bottom: 1px solid var(--color-borde);
    }
    
    /* Excepción para la columna de referencia */
    .reporte-tabla td.celda-referencia {
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
      max-width: none;
    }
    
    .reporte-tabla tr:hover td,
    .reporte-tabla tr:hover th {
      background-color: rgba(27, 137, 67, 0.15);
    }
    
    .reporte-tabla tbody tr {
      border-bottom: 1px solid var(--color-borde);
      transition: background-color 0.2s ease;
    }
    
    .reporte-tabla tbody tr:last-child {
      border-bottom: none;
    }
    
    .reporte-tabla .column-hover {
      background-color: rgba(27, 137, 67, 0.15) !important;
      position: relative;
      z-index: 1;
    }
    .text-right {
        text-align: right !important;
    }
    
    .celda-editable {
      background-color: rgba(27, 137, 67, 0.05) !important;
      border: 1px dashed rgba(27, 137, 67, 0.2);
      cursor: text;
      min-width: 80px;
      padding: 8px !important;
      white-space: normal; /* Permitir saltos de línea */
      word-wrap: break-word;
    }
    
    .celda-editable:hover {
      background-color: rgba(27, 137, 67, 0.1) !important;
      border-color: rgba(27, 137, 67, 0.4);
    }
    
    .celda-editable:focus {
      outline: 2px solid var(--color-principal);
      background-color: rgba(27, 137, 67, 0.15) !important;
    }

    /* Estilos específicos para la columna de referencia con saltos de línea */
    .celda-referencia {
      line-height: 1.4;
      min-width: 200px;
      max-width: none;
      vertical-align: top;
      white-space: normal;
      word-wrap: break-word;
      text-overflow: unset;
    }

    /* Grid para los pasos lado a lado */
    .config-steps-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* Dos columnas para paso 1 y 2 */
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }
    
    /* Responsive para pasos */
    @media (max-width: 768px) {
      .config-steps-grid {
        grid-template-columns: 1fr; /* Una columna en mobile */
      }
    }
    
    .config-step {
      background-color: var(--color-superficie);
      border: 1px solid var(--color-borde);
      border-radius: var(--border-radius);
      padding: var(--spacing-md);
      transition: all 0.2s ease;
      margin-bottom: 0; /* Remove previous margin */
    }
    
    .config-step:hover {
      box-shadow: var(--shadow-sm);
    }

    /* Estilos para el botón de copiar fila */
    .fila-con-hover {
      position: relative;
    }
    
    .btn-copiar-fila {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      background-color: var(--color-secundario);
      color: var(--color-texto-claro);
      border: none;
      border-radius: var(--border-radius-sm);
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 15;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    
    .fila-con-hover:hover .btn-copiar-fila {
      opacity: 1;
      visibility: visible;
    }
    
    .btn-copiar-fila:hover {
      background-color: var(--color-secundario-hover);
      box-shadow: var(--shadow-md);
      transform: translateY(-50%) scale(1.05);
    }
    
    .btn-copiar-fila:active {
      transform: translateY(-50%) scale(0.95);
    }
    
    .btn-copiar-fila i {
      font-size: 10px;
    }

    /* Estilos para los botones de acciones */
    .acciones-celda {
      text-align: center;
      padding: 8px 4px !important;
      width: 120px;
      min-width: 120px;
    }
    
    .btn-accion i {
      font-size: 9px;
    }

    /* Estilos para la columna de acciones */
    .acciones-column {
      width: 80px;
      text-align: center;
    }
    
    .acciones-container {
      display: flex;
      justify-content: center;
      gap: var(--spacing-xs);
      opacity: 1; /* Siempre visible */
      transition: opacity 0.2s ease;
    }
    
    .btn-accion {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: var(--border-radius-sm);
      transition: all 0.2s ease;
      color: var(--color-texto-secundario);
      font-size: 14px;
      position: relative;
    }
    
    .btn-accion:hover {
      background-color: var(--color-superficie-alt);
      color: var(--color-principal);
      transform: scale(1.1);
    }
    
    .btn-accion.btn-split:hover {
      color: var(--color-secundario);
    }
    
    .btn-accion.btn-delete:hover {
      color: var(--color-danger);
    }

    /* Estilos para el modal de split */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background-color: var(--color-superficie);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-xl);
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
    
    .modal-overlay.active .modal-content {
      transform: scale(1);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--color-borde);
    }
    
    .modal-header h3 {
      margin: 0;
      color: var(--color-texto);
      font-size: 18px;
      font-weight: 600;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--color-texto-secundario);
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
    
    .modal-close:hover {
      background-color: var(--color-superficie-alt);
      color: var(--color-danger);
    }
    
    .split-info {
      background-color: var(--color-superficie-alt);
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-lg);
    }
    
    .split-info p {
      margin: 0;
      font-size: 14px;
      color: var(--color-texto);
    }
    
    .split-info strong {
      color: var(--color-principal);
    }
    
    .split-lines {
      margin-bottom: var(--spacing-lg);
    }
    
    .split-line {
      display: grid;
      grid-template-columns: 1fr 150px 40px;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      align-items: center;
    }
    
    .split-line input {
      padding: 8px var(--spacing-md);
      border: 1px solid var(--color-borde);
      border-radius: var(--border-radius-sm);
      font-size: 14px;
      font-family: inherit;
    }
    
    .split-line input:focus {
      outline: none;
      border-color: var(--color-principal);
      box-shadow: 0 0 0 2px rgba(27, 137, 67, 0.2);
    }
    
    .split-line .btn-remove {
      background: none;
      border: none;
      color: var(--color-danger);
      cursor: pointer;
      font-size: 16px;
      padding: 4px;
      border-radius: var(--border-radius-sm);
      transition: all 0.2s ease;
    }
    
    .split-line .btn-remove:hover {
      background-color: rgba(231, 76, 60, 0.1);
    }
    
    .split-totals {
      background-color: var(--color-superficie-sec);
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-lg);
    }
    
    .split-total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }
    
    .split-total-row:last-child {
      margin-bottom: 0;
      font-weight: 600;
      font-size: 16px;
      padding-top: var(--spacing-sm);
      border-top: 1px solid var(--color-borde);
    }
    
    .total-amount {
      font-family: 'Courier New', monospace;
    }
    
    .total-error {
      color: var(--color-danger);
    }
    
    .total-success {
      color: var(--color-success);
    }
    
    .modal-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .btn-add-line {
      background-color: var(--color-secundario);
      color: var(--color-texto-claro);
      border: none;
      padding: 8px var(--spacing-md);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-family: inherit;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      transition: background-color 0.2s ease;
    }
    
    .btn-add-line:hover {
      background-color: var(--color-secundario-hover);
    }
    
    .modal-buttons {
      display: flex;
      gap: var(--spacing-md);
    }
    
    .btn-modal {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: 14px;
      font-family: inherit;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .btn-modal.btn-cancel {
      background-color: var(--color-texto-secundario);
      color: var(--color-texto-claro);
    }
    
    .btn-modal.btn-cancel:hover {
      background-color: #555555;
    }
    
    .btn-modal.btn-confirm {
      background-color: var(--color-principal);
      color: var(--color-texto-claro);
    }
    
    .btn-modal.btn-confirm:hover:not(:disabled) {
      background-color: var(--color-principal-hover);
    }
    
    .btn-modal.btn-confirm:disabled {
      background-color: var(--color-texto-secundario);
      cursor: not-allowed;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div class="reporte-container">
    <!-- Título -->
    <div class="titulo-reporte">
        <h1><i class="fas fa-university" style="color: var(--color-principal);"></i> Carga de Movimientos Bancarios</h1>
    </div>

    <!-- Sección de Configuración -->
    <div class="config-steps-grid">
        <!-- Sección de Carga de Archivo -->
        <div class="config-step active">
            <div class="step-header">
                <div class="step-number">01</div>
                <h4>Cargar archivo de movimientos</h4>
            </div>
            <div class="step-content">
                <div class="config-controls">
                    <button id="btn-cargar-bancos" class="btn">
                        <i class="fas fa-upload"></i> Seleccionar Excel
                    </button>
                    <input type="file" id="bancos-file-input" accept=".xls,.xlsx,.csv" style="display: none;">
                    <span id="bancos-nombre-archivo" style="font-size: 12px; color: var(--color-texto-secundario); margin-left: 8px; align-self: center;"></span>
                </div>
                 <div id="info-cuenta-container" style="margin-top: var(--spacing-md); font-size: 13px; color: var(--color-texto-secundario); background-color: var(--color-superficie-alt); padding: var(--spacing-sm); border-radius: var(--border-radius-sm);">
                    <p><strong>Cuenta:</strong> <span id="info-cuenta-numero">---</span></p>
                    <p><strong>Moneda:</strong> <span id="info-cuenta-moneda">---</span></p>
                    <p><strong>Tipo:</strong> <span id="info-cuenta-tipo">---</span></p>
                </div>
            </div>
        </div>

        <!-- Sección de Carga de Transacciones -->
        <div class="config-step">
            <div class="step-header">
                <div class="step-number">02</div>
                <h4>Cargar transacciones</h4>
            </div>
            <div class="step-content">
                <div class="config-controls">
                    <button id="btn-cargar-transacciones" class="btn" disabled>
                        <i class="fas fa-cloud-upload-alt"></i> Enviar Transacciones
                    </button>
                    <span id="estado-carga" style="font-size: 12px; color: var(--color-texto-secundario); margin-left: 8px; align-self: center;"></span>
                </div>
                <div id="resultado-carga" style="margin-top: var(--spacing-md); font-size: 13px; padding: var(--spacing-sm); border-radius: var(--border-radius-sm); display: none;">
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de Tabla de Movimientos -->
    <div class="seccion reporte-ventas-container"> <!-- Reuse class for styling -->
        <div class="tabla-header">
            <h3><i class="fas fa-list-alt" style="color: var(--color-principal);"></i> Movimientos Registrados</h3>
        </div>
        <div class="tabla-body">
            <div class="reporte-tabla-container">
                <table class="reporte-tabla" id="tabla-movimientos-bancos">
                    <thead>
                        <tr>
                            <th>Acciones</th>
                            <th>Fecha</th>
                            <th>Concepto</th>
                            <th>Proveedor</th>
                            <th class="text-right">Monto</th>
                            <th class="text-right">Saldo</th>
                            <th># Operacion</th>
                            <th>Hora</th>
                            <th>Referencia</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 20px; color: var(--color-texto-secundario);">Cargue un archivo para ver los movimientos.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
  </div>

  <!-- Modal de Split -->
  <div id="split-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-cut"></i> Dividir Transacción</h3>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      
      <div class="split-info">
        <p><strong>Monto Original:</strong> <span id="split-original-amount" class="total-amount">0.00</span></p>
        <p><strong>Concepto:</strong> <span id="split-original-concept">---</span></p>
      </div>
      
      <div class="split-lines" id="split-lines-container">
        <!-- Las líneas de split se generarán dinámicamente -->
      </div>
      
      <div class="split-totals">
        <div class="split-total-row">
          <span>Total Asignado:</span>
          <span id="split-total-assigned" class="total-amount">0.00</span>
        </div>
        <div class="split-total-row">
          <span>Diferencia:</span>
          <span id="split-difference" class="total-amount">0.00</span>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="btn-add-line" id="btn-add-split-line">
          <i class="fas fa-plus"></i> Agregar Línea
        </button>
        
        <div class="modal-buttons">
          <button class="btn-modal btn-cancel" id="btn-cancel-split">Cancelar</button>
          <button class="btn-modal btn-confirm" id="btn-confirm-split" disabled>Confirmar Split</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Función global para eliminar una fila
    function eliminarFila(boton) {
      const fila = boton.closest('tr');
      const tablaBody = fila.parentNode;
      
      // Confirmar eliminación
      if (confirm('¿Está seguro de que desea eliminar esta transacción?')) {
        // Efecto visual antes de eliminar
        fila.style.backgroundColor = 'rgba(231, 76, 60, 0.2)';
        fila.style.transition = 'all 0.3s ease';
        
        setTimeout(() => {
          fila.remove();
          
          // Actualizar el contador de transacciones
          const totalFilas = tablaBody.querySelectorAll('tr').length;
          const estadoCarga = document.getElementById('estado-carga');
          
          if (totalFilas === 0) {
            tablaBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--color-texto-secundario);">No hay movimientos para mostrar.</td></tr>';
            const btnCargarTransacciones = document.getElementById('btn-cargar-transacciones');
            btnCargarTransacciones.disabled = true;
            estadoCarga.textContent = '';
          } else {
            estadoCarga.textContent = `${totalFilas} transacciones listas para enviar`;
          }
        }, 300);
      }
    }

    // Variables globales para el modal de split
    let currentSplitRow = null;
    let originalAmount = 0;
    let splitLines = [];

    // Función para abrir el modal de split
    function abrirModalSplit(button) {
      const row = button.closest('tr');
      currentSplitRow = row;
      
      // Obtener datos de la fila
      const cells = row.querySelectorAll('td');
      const concepto = cells[2].textContent.trim(); // Ajustado para nueva estructura
      const montoTexto = cells[4].textContent.trim(); // Ajustado para nueva estructura
      originalAmount = montoTexto === '---' ? 0 : parseFloat(montoTexto.replace(/[,\s]/g, '')) || 0;
      
      // Configurar el modal
      document.getElementById('split-original-concept').textContent = concepto;
      document.getElementById('split-original-amount').textContent = formatNumber(originalAmount);
      
      // Inicializar con 2 líneas
      splitLines = [
        { concepto: concepto, monto: originalAmount / 2 },
        { concepto: '', monto: originalAmount / 2 }
      ];
      
      renderSplitLines();
      updateSplitTotals();
      
      // Mostrar modal
      document.getElementById('split-modal').classList.add('active');
    }

    // Función para renderizar las líneas de split
    function renderSplitLines() {
      const container = document.getElementById('split-lines-container');
      container.innerHTML = '';
      
      splitLines.forEach((line, index) => {
        const lineDiv = document.createElement('div');
        lineDiv.className = 'split-line';
        lineDiv.innerHTML = `
          <input type="text" placeholder="Concepto" value="${line.concepto}" 
                 onchange="updateSplitLine(${index}, 'concepto', this.value)">
          <input type="number" step="0.01" placeholder="Monto" value="${line.monto}" 
                 onchange="updateSplitLine(${index}, 'monto', parseFloat(this.value) || 0)">
          <button class="btn-remove" onclick="removeSplitLine(${index})" 
                  ${splitLines.length <= 2 ? 'style="visibility: hidden;"' : ''}>
            <i class="fas fa-times"></i>
          </button>
        `;
        container.appendChild(lineDiv);
      });
    }

    // Función para actualizar una línea de split
    function updateSplitLine(index, field, value) {
      if (splitLines[index]) {
        splitLines[index][field] = value;
        updateSplitTotals();
      }
    }

    // Función para eliminar una línea de split
    function removeSplitLine(index) {
      if (splitLines.length > 2) {
        splitLines.splice(index, 1);
        renderSplitLines();
        updateSplitTotals();
      }
    }

    // Función para agregar una nueva línea de split
    function addSplitLine() {
      splitLines.push({ concepto: '', monto: 0 });
      renderSplitLines();
      updateSplitTotals();
    }

    // Función para actualizar los totales
    function updateSplitTotals() {
      const totalAssigned = splitLines.reduce((sum, line) => sum + (line.monto || 0), 0);
      const difference = originalAmount - totalAssigned;
      
      document.getElementById('split-total-assigned').textContent = formatNumber(totalAssigned);
      document.getElementById('split-difference').textContent = formatNumber(difference);
      
      // Actualizar clases de color
      const diffElement = document.getElementById('split-difference');
      const confirmButton = document.getElementById('btn-confirm-split');
      
      if (Math.abs(difference) < 0.01) { // Consideramos diferencias menores a 0.01 como iguales
        diffElement.className = 'total-amount total-success';
        confirmButton.disabled = false;
      } else {
        diffElement.className = 'total-amount total-error';
        confirmButton.disabled = true;
      }
    }

    // Función para confirmar el split
    function confirmarSplit() {
      if (!currentSplitRow || Math.abs(originalAmount - splitLines.reduce((sum, line) => sum + (line.monto || 0), 0)) >= 0.01) {
        return;
      }
      
      // Obtener datos originales de la fila
      const cells = currentSplitRow.querySelectorAll('td');
      const fecha = cells[1].textContent.trim(); // Ajustado para nueva estructura
      const proveedor = cells[3].textContent.trim(); // Ajustado para nueva estructura
      const saldo = cells[5].textContent.trim(); // Ajustado para nueva estructura
      const numOperacion = cells[6].textContent.trim(); // Ajustado para nueva estructura
      const hora = cells[7].textContent.trim(); // Ajustado para nueva estructura
      const referencia = cells[8].textContent.trim(); // Ajustado para nueva estructura
      
      // Eliminar la fila original
      currentSplitRow.remove();
      
      // Crear nuevas filas para cada split
      const tablaBody = document.getElementById('tabla-movimientos-bancos').querySelector('tbody');
      splitLines.forEach(line => {
        if (line.concepto.trim() !== '' && line.monto !== 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="acciones-column">
              <div class="acciones-container">
                <button class="btn-accion btn-split" onclick="abrirModalSplit(this)">
                  <i class="fas fa-cut"></i>
                </button>
                <button class="btn-accion btn-delete" onclick="eliminarFila(this)">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
            <td>${fecha}</td>
            <td class="celda-editable" contenteditable="true">${line.concepto}</td>
            <td class="celda-editable" contenteditable="true">${proveedor}</td>
            <td class="text-right">${formatNumber(line.monto)}</td>
            <td class="text-right">${saldo}</td>
            <td>${numOperacion}</td>
            <td>${hora}</td>
            <td class="celda-editable celda-referencia" contenteditable="true">${referencia}</td>
          `;
          tablaBody.appendChild(tr);
        }
      });
      
      cerrarModalSplit();
    }

    // Función para cerrar el modal
    function cerrarModalSplit() {
      document.getElementById('split-modal').classList.remove('active');
      currentSplitRow = null;
      splitLines = [];
    }

    // Función global para formatear números
    function formatNumber(num, decimals = 2) {
      if (num === undefined || num === null || String(num).trim() === '') {
          return '---'; 
      }
      const numericValue = Number(num);
      if (isNaN(numericValue)) {
          return '---'; 
      }
      return numericValue.toLocaleString('es-PE', { 
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      const btnCargarBancos = document.getElementById('btn-cargar-bancos');
      const bancosFileInput = document.getElementById('bancos-file-input');
      const bancosNombreArchivo = document.getElementById('bancos-nombre-archivo');
      const tablaMovimientosBancosBody = document.getElementById('tabla-movimientos-bancos').querySelector('tbody');
      
      const infoCuentaNumero = document.getElementById('info-cuenta-numero');
      const infoCuentaMoneda = document.getElementById('info-cuenta-moneda');
      const infoCuentaTipo = document.getElementById('info-cuenta-tipo');

      // Variables para el paso 2
      const btnCargarTransacciones = document.getElementById('btn-cargar-transacciones');
      const estadoCarga = document.getElementById('estado-carga');
      const resultadoCarga = document.getElementById('resultado-carga');

      // Variable global para almacenar los datos del CSV
      let csvData = [];
      
      // Variable global para almacenar los movimientos procesados
      let movimientosProcesados = [];

      // URLs para validación de saldos (mismo patrón que consolidador de ventas)
      const csvUrls = {
        'PEN': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRhWBlTXTz5h_v8OIH-3LrKdc6tjqLR15ZG1LlxsFRbZ6867Rn0L3jnWYOUtH6Cv-LQ7QRpULms8ah/pub?gid=0&single=true&output=csv',
        'USD': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS9bRPb-3jZj8mBz7Al-4p39nG2ua3WWgva9ieg46GvH9jAg2AYk5oSXpEW1H0lWXEJCFZgSnhCv3z3/pub?gid=0&single=true&output=csv'
      };

      // Variables para validación de saldos
      let csvValidacionData = [];
      let saldoValidacionInfo = null;

      if (btnCargarBancos && bancosFileInput) {
        btnCargarBancos.addEventListener('click', () => {
          bancosFileInput.click();
        });

        bancosFileInput.addEventListener('change', handleFileSelectBancos);
      }

      // Event listener para el botón de cargar transacciones
      if (btnCargarTransacciones) {
        btnCargarTransacciones.addEventListener('click', enviarTransacciones);
      }

      // Cargar CSV al inicializar la página
      cargarCSVExterno();

      // == Funciones para validación de saldos ==
      
      function parseDateFromCSV(dateStr) {
        if (!dateStr || dateStr.trim() === '') return null;
        
        // Manejar formato DD/MM/YYYY
        const dateParts = dateStr.trim().split('/');
        if (dateParts.length === 3) {
          const day = parseInt(dateParts[0]);
          const month = parseInt(dateParts[1]) - 1; // Mes es 0-indexado en JS
          const year = parseInt(dateParts[2]);
          
          if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
            return new Date(Date.UTC(year, month, day));
          }
        }
        
        return null;
      }
      
      function formatDateISO(date) {
        if (!(date instanceof Date) || isNaN(date)) return '';
        const year = date.getUTCFullYear();
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const day = String(date.getUTCDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      function formatDateDisplay(date) {
        if (!(date instanceof Date) || isNaN(date)) return '--/--/----';
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();
        return `${day}/${month}/${year}`;
      }

      function parseCSVLineValidacion(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        
        result.push(current.trim());
        return result;
      }

      async function cargarCSVValidacion(moneda) {
        const url = csvUrls[moneda];
        if (!url) {
          console.warn('No hay URL configurada para la moneda:', moneda);
          return [];
        }

        try {
          console.log('Cargando CSV de validación desde:', url);
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
          }
          
          const csvText = await response.text();
          console.log('CSV de validación cargado exitosamente');
          
          // Parsear CSV
          const lines = csvText.split('\n').filter(line => line.trim() !== '');
          const csvDataValidacion = lines.map(line => parseCSVLineValidacion(line));
          
          console.log('Datos CSV validación parseados:', csvDataValidacion.length, 'filas');
          return csvDataValidacion;
          
        } catch (error) {
          console.error('Error al cargar CSV de validación:', error);
          return [];
        }
      }

      function obtenerDiaAnterior(fechaStr) {
        // Convertir fecha DD/MM/YYYY a objeto Date
        const dateParts = fechaStr.split('/');
        if (dateParts.length !== 3) return null;
        
        const day = parseInt(dateParts[0]);
        const month = parseInt(dateParts[1]) - 1;
        const year = parseInt(dateParts[2]);
        
        const fecha = new Date(Date.UTC(year, month, day));
        if (isNaN(fecha)) return null;
        
        // Restar un día
        fecha.setUTCDate(fecha.getUTCDate() - 1);
        return formatDateDisplay(fecha);
      }

      function obtenerSaldoDelDiaAnterior(fechaUltimoDia, csvDataValidacion) {
        const fechaAnterior = obtenerDiaAnterior(fechaUltimoDia);
        if (!fechaAnterior) return null;

        console.log('Buscando SALDO FINAL del día anterior:', fechaAnterior);

        // Buscar la fila con fecha del día anterior Y concepto "SALDO FINAL"
        let filaEncontrada = null;
        csvDataValidacion.forEach((row, rowIndex) => {
          if (rowIndex === 0 || !row || row.length < 8) return; // Saltar header y filas inválidas
          
          const fechaStr = row[0]; // Columna: Fecha
          const concepto = row[1] || ''; // Columna: Concepto
          const proveedor = row[2] || ''; // Columna: Proveedor
          const montoStr = row[3] || '0'; // Columna: Monto
          const saldoStr = row[4] || '0'; // Columna: Saldo
          const operacion = row[5] || ''; // Columna: # Operacion
          const hora = row[6] || ''; // Columna: Hora
          const referencia = row[7] || ''; // Columna: Referencia
          
          // Buscar fila con fecha del día anterior Y concepto "SALDO FINAL"
          if (fechaStr === fechaAnterior && concepto.toUpperCase().trim() === 'SALDO FINAL') {
            const saldo = parseFloat(saldoStr.replace(/[^-0-9.]/g, '')) || 0;
            filaEncontrada = {
              fecha: fechaStr,
              concepto: concepto,
              proveedor: proveedor,
              monto: parseFloat(montoStr.replace(/[^-0-9.]/g, '')) || 0,
              saldo: saldo,
              operacion: operacion,
              hora: hora,
              referencia: referencia
            };
            console.log('Fila SALDO FINAL encontrada:', filaEncontrada);
          }
        });

        if (!filaEncontrada) {
          console.log('No se encontró fila SALDO FINAL para el día anterior:', fechaAnterior);
          return null;
        }

        console.log('Saldo final del día anterior (columna Saldo):', filaEncontrada.saldo);
        return {
          fecha: fechaAnterior,
          saldoFinal: filaEncontrada.saldo,
          concepto: filaEncontrada.concepto,
          transacciones: 1
        };
      }

      async function validarSaldos(movimientos, moneda) {
        if (!movimientos || movimientos.length === 0) {
          console.log('No hay movimientos para validar');
          return;
        }

        // Obtener la fecha del último día del Excel
        const ultimaTransaccion = movimientos[movimientos.length - 1];
        const fechaUltimoDia = ultimaTransaccion.fecha;
        
        console.log('Última fecha del Excel:', fechaUltimoDia, 'Moneda:', moneda);

        // Cargar CSV de validación
        csvValidacionData = await cargarCSVValidacion(moneda);
        if (csvValidacionData.length === 0) {
          mostrarValidacionSaldos('⚠️ No se pudo cargar datos para validación de saldos.', 'warning');
          return;
        }

        // Obtener saldo del día anterior desde CSV
        saldoValidacionInfo = obtenerSaldoDelDiaAnterior(fechaUltimoDia, csvValidacionData);
        
        if (!saldoValidacionInfo) {
          mostrarValidacionSaldos(`⚠️ No se encontraron datos del día anterior (${obtenerDiaAnterior(fechaUltimoDia)}) para validar saldos.`, 'warning');
          return;
        }

                 // Obtener saldo inicial calculado (del Excel en pantalla)
         // Saldo inicial = saldo de la última fila - monto de la última fila
         const saldoTextoUltima = ultimaTransaccion.saldo;
         const saldoUltimaFila = parseFloat(String(saldoTextoUltima).replace(/[,\s]/g, '')) || 0;
         const montoUltimaFila = parseFloat(String(ultimaTransaccion.monto).replace(/[,\s]/g, '')) || 0;
         const saldoInicialCalculado = saldoUltimaFila - montoUltimaFila;

         // Comparar saldos: Saldo inicial calculado vs Saldo final del día anterior (CSV)
         const diferencia = Math.abs(saldoInicialCalculado - saldoValidacionInfo.saldoFinal);
         const tolerancia = 0.01; // Tolerancia de 1 centavo

         console.log('Validación de saldos:');
         console.log('- Saldo inicial calculado (Excel):', saldoInicialCalculado);
         console.log('- Saldo final día anterior (CSV):', saldoValidacionInfo.saldoFinal);
         console.log('- Diferencia:', diferencia);

         if (diferencia <= tolerancia) {
           mostrarValidacionSaldos(`✅ Validación exitosa: Los saldos coinciden. Saldo inicial: ${formatNumber(saldoInicialCalculado)} = Saldo final día anterior: ${formatNumber(saldoValidacionInfo.saldoFinal)}. Diferencia: ${formatNumber(diferencia)}`, 'success');
         } else {
           mostrarValidacionSaldos(`❌ Discrepancia encontrada: Saldo inicial calculado (${formatNumber(saldoInicialCalculado)}) vs Saldo final del ${saldoValidacionInfo.fecha} (${formatNumber(saldoValidacionInfo.saldoFinal)}). Diferencia: ${formatNumber(diferencia)}`, 'error');
         }
      }

      function mostrarValidacionSaldos(mensaje, tipo) {
        // Crear o actualizar elemento de validación
        let validacionElement = document.getElementById('validacion-saldos');
        if (!validacionElement) {
          validacionElement = document.createElement('div');
          validacionElement.id = 'validacion-saldos';
          validacionElement.style.cssText = `
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-sm);
            font-size: 13px;
            font-weight: 500;
            display: block;
          `;
          
          // Insertar después del info-cuenta-container
          const infoCuentaContainer = document.getElementById('info-cuenta-container');
          infoCuentaContainer.parentNode.insertBefore(validacionElement, infoCuentaContainer.nextSibling);
        }

        validacionElement.textContent = mensaje;
        
        if (tipo === 'success') {
          validacionElement.style.backgroundColor = 'rgba(46, 204, 113, 0.1)';
          validacionElement.style.color = 'var(--color-success)';
          validacionElement.style.border = '1px solid rgba(46, 204, 113, 0.3)';
        } else if (tipo === 'error') {
          validacionElement.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
          validacionElement.style.color = 'var(--color-danger)';
          validacionElement.style.border = '1px solid rgba(231, 76, 60, 0.3)';
        } else if (tipo === 'warning') {
          validacionElement.style.backgroundColor = 'rgba(230, 126, 34, 0.1)';
          validacionElement.style.color = 'var(--color-warning)';
          validacionElement.style.border = '1px solid rgba(230, 126, 34, 0.3)';
        }
      }

      // == Funciones existentes (modificadas para incluir validación) ==

      async function cargarCSVExterno() {
        try {
          const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRKeFI1f8VGIlLuN_yPSctoqlyrAUiSU7TwYIXiUs1X83gIWSnwprTN50AZ_hKSzmcigHxOXiQGoUTl/pub?gid=0&single=true&output=csv');
          const csvText = await response.text();
          
          // Parsear CSV
          const lines = csvText.split('\n');
          const headers = lines[0].split(',');
          
          csvData = [];
          for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim() === '') continue;
            
            const values = parseCSVLine(lines[i]);
            if (values.length >= headers.length) {
              const record = {};
              headers.forEach((header, index) => {
                record[header.trim()] = values[index] ? values[index].trim() : '';
              });
              csvData.push(record);
            }
          }
          
          console.log(`CSV cargado exitosamente: ${csvData.length} registros`);
        } catch (error) {
          console.error('Error al cargar CSV:', error);
        }
      }

      function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        
        result.push(current);
        return result;
      }

      function buscarEnCSV(numeroOperacion) {
        if (!numeroOperacion || numeroOperacion === '---') return null;
        
        // Buscar coincidencia parcial - el número del CSV debe coincidir con el final del número del Excel
        for (let record of csvData) {
          const csvNumero = String(record['número_operación'] || '').trim();
          if (csvNumero && numeroOperacion.endsWith(csvNumero)) {
            return record;
          }
        }
        return null;
      }

      function transformarNumeroOperacion(descripcionOp, numeroOp) {
        if (!numeroOp || numeroOp === '---') return numeroOp;
        
        const descripcion = String(descripcionOp || '').toUpperCase().trim();
        
        if (descripcion.includes('TRANFERENCIA CCE')) {
          // Reemplazar el primer '4' por '2'
          const numeroStr = String(numeroOp).trim();
          const primerCuatroIndex = numeroStr.indexOf('4');
          if (primerCuatroIndex !== -1) {
            return numeroStr.substring(0, primerCuatroIndex) + '2' + numeroStr.substring(primerCuatroIndex + 1);
          }
        }
        return numeroOp;
      }

      function formatDateFromExcel(excelValue) {
        if (typeof excelValue === 'number') {
          const date = XLSX.SSF.parse_date_code(excelValue);
          if (date) {
            return `${String(date.d).padStart(2, '0')}/${String(date.m).padStart(2, '0')}/${date.y}`;
          }
        } else if (typeof excelValue === 'string') {
          return excelValue.trim() !== '' ? excelValue : '---';
        }
        return '---';
      }

      function formatTimeFromExcel(excelValue) {
        if (typeof excelValue === 'number') {
          let hours = Math.floor(excelValue * 24);
          let minutes = Math.floor(((excelValue * 24) - hours) * 60);
          let seconds = Math.floor(((((excelValue * 24) - hours) * 60) - minutes) * 60);
          
          return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        } else if (typeof excelValue === 'string'){
          if (/^\d{2}:\d{2}:\d{2}$/.test(excelValue.trim())) {
              return excelValue.trim();
          }
        }
        return '---';
      }

      function formatNumberWithSpaces(num, decimals = 2) {
        if (num === undefined || num === null || String(num).trim() === '') {
            return '---'; 
        }
        const numericValue = Number(num);
        if (isNaN(numericValue)) {
            return '---'; 
        }
        // Formatear con comas primero y luego reemplazar comas por espacios
        const formatted = numericValue.toLocaleString('es-PE', { 
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
        });
        return formatted.replace(/,/g, ' ');
      }

      function handleFileSelectBancos(event) {
        const file = event.target.files[0];
        if (!file) {
          bancosNombreArchivo.textContent = '';
          return;
        }
        bancosNombreArchivo.textContent = file.name;

        const reader = new FileReader();
        reader.onload = function(e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' }); 
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true, defval: "" });

          if (jsonData.length < 6) {
            alert("El archivo no tiene suficientes filas para procesar. Se esperan datos de cuenta y movimientos.");
            return;
          }

          infoCuentaNumero.textContent = jsonData[0] && jsonData[0][1] !== undefined ? String(jsonData[0][1]) : '---';
          infoCuentaMoneda.textContent = jsonData[1] && jsonData[1][1] !== undefined ? String(jsonData[1][1]) : '---';
          infoCuentaTipo.textContent = jsonData[2] && jsonData[2][1] !== undefined ? String(jsonData[2][1]) : '---';
          
          const movimientos = [];
          for (let i = 5; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (!row || row.length === 0 || (String(row[0]).trim() === '' && String(row[3]).trim() === '')) continue; 

            const fecha = row[0]; 
            const descripcionOperacion = String(row[2] || '');
            const monto = row[3];
            const saldoExcel = row[4]; // Extraer saldo del Excel
            let operacionNumero = String(row[6] || '');
            const horaOperacion = row[7];
            const referencia2 = String(row[10] || '');

            // Aplicar transformación del número de operación
            operacionNumero = transformarNumeroOperacion(descripcionOperacion, operacionNumero);

            // Buscar datos en CSV para hacer el cruce
            const csvMatch = buscarEnCSV(operacionNumero);

            let concepto = descripcionOperacion.trim() !== '' ? descripcionOperacion : '---';
            let proveedor = '---';
            let referencia = referencia2.trim() !== '' ? referencia2 : '---';

            // Aplicar reglas de transformación según el tipo de transacción
            const descripcionUpper = descripcionOperacion.toUpperCase().trim();
            
            // Regla TRANSF.EXT -> Prioridad máxima
            if (descripcionUpper.includes('TRANSF.EXT')) {
              console.log('TRANSF.EXT detectado:', descripcionOperacion, 'csvMatch:', csvMatch);
              if (csvMatch) {
                concepto = csvMatch['referencia'] || concepto;
                proveedor = csvMatch['empresa_destino'] || proveedor;
                // Reemplazar espacios con saltos de línea solo para egresos (montos negativos)
                if (csvMatch['mensaje']) {
                  const esEgreso = monto < 0;
                  referencia = esEgreso ? csvMatch['mensaje'].replace(/\s+/g, '<br>') : csvMatch['mensaje'];
                } else {
                  referencia = referencia;
                }
              }
            }
            // Regla 1: IMPUESTO, COM.MANTENIM, ENVIO.EST.CTA, COM.OP -> COMISIÓN BANCARIA
            else if (descripcionUpper.startsWith('IMPUESTO') || 
                descripcionUpper.startsWith('COM.MANTENIM') || 
                descripcionUpper.startsWith('ENVIO.EST.CTA') || 
                descripcionUpper.startsWith('COM.OP')) {
              referencia = descripcionOperacion; // Concepto real va a referencia
              concepto = 'COMISION BANCARIA';
            }
            // Regla 2: HABER -> PLANILLA
            else if (descripcionUpper.startsWith('HABER')) {
              // Para HABER, mantener la referencia original del Excel
              concepto = 'PLANILLA';
            }
            // Regla 3: BACK -> BACKUS
            else if (descripcionUpper.startsWith('BACK')) {
              concepto = 'BACKUS';
              proveedor = 'BACKUS';
            }
            // Regla 4: PAGO IMPUES -> SUNAT
            else if (descripcionUpper.startsWith('PAGO IMPUES')) {
              proveedor = 'SUNAT';
            }
            // Si hay match con CSV y no se aplicó ninguna regla especial, usar datos del CSV
            else if (csvMatch) {
              concepto = csvMatch['referencia'] || concepto;
              proveedor = csvMatch['empresa_destino'] || proveedor;
              // Reemplazar espacios con saltos de línea solo para egresos (montos negativos)
              if (csvMatch['mensaje']) {
                const esEgreso = monto < 0;
                referencia = esEgreso ? csvMatch['mensaje'].replace(/\s+/g, '<br>') : csvMatch['mensaje'];
              } else {
                referencia = referencia;
              }
            }

            // Determinar el monto a mostrar en la fila original
            let montoFila = monto;
            if ((descripcionUpper.includes('TRANFERENCIA CCE') || descripcionUpper.includes('TRANSF.EXT')) && csvMatch) {
              // Para TRANFERENCIA CCE y TRANSF.EXT, usar el monto del CSV en la fila original
              montoFila = Number(csvMatch['monto_neto']) || monto;
            }

            // Crear la fila original
            const movimientoOriginal = {
              fecha: formatDateFromExcel(fecha),
              concepto: concepto,
              proveedor: proveedor,
              monto: montoFila,
              saldo: formatNumber(saldoExcel),
              numOperacion: operacionNumero.trim() !== '' ? operacionNumero : '---',
              hora: formatTimeFromExcel(horaOperacion),
              referencia: referencia
            };

            movimientos.push(movimientoOriginal);

            // Si es TRANSF.EXT o TRANFERENCIA CCE, crear fila adicional de comisión calculada
            if ((descripcionUpper.includes('TRANSF.EXT') || descripcionUpper.includes('TRANFERENCIA CCE')) && csvMatch) {
              const montoExcel = Number(monto) || 0;
              const montoCSV = Number(csvMatch['monto_neto']) || 0;
              
              // Para montos negativos: Excel es más negativo que CSV
              // Ejemplo: CSV = -4,014.22, Excel = -4,500.00
              // Comisión = Excel - CSV = -4,500.00 - (-4,014.22) = -485.78
              const comision = montoExcel - montoCSV;

              console.log('Calculando comisión para', descripcionUpper.includes('TRANSF.EXT') ? 'TRANSF.EXT' : 'TRANFERENCIA CCE', 
                         '- Excel:', montoExcel, '- CSV:', montoCSV, '- Comisión:', comision);

              const movimientoComision = {
                fecha: formatDateFromExcel(fecha),
                concepto: 'COMISION BANCARIA',
                proveedor: proveedor, // Mismo proveedor
                monto: comision,
                saldo: formatNumber(saldoExcel),
                numOperacion: operacionNumero.trim() !== '' ? operacionNumero : '---',
                hora: formatTimeFromExcel(horaOperacion),
                referencia: formatNumberWithSpaces(montoExcel) // Monto del Excel como referencia
              };

              movimientos.push(movimientoComision);
              console.log('Línea de comisión creada:', movimientoComision);
            }
          }
          displayDataBancos(movimientos);
        };
        reader.readAsArrayBuffer(file);
      }

      async function displayDataBancos(movimientos) {
        tablaMovimientosBancosBody.innerHTML = '';

        if (movimientos.length === 0) {
          tablaMovimientosBancosBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--color-texto-secundario);">No se encontraron movimientos en el archivo o no tienen el formato esperado.</td></tr>';
          movimientosProcesados = [];
          btnCargarTransacciones.disabled = true;
          estadoCarga.textContent = '';
          return;
        }

        // Almacenar los movimientos en la variable global
        movimientosProcesados = movimientos;

        // Ejecutar validación de saldos
        const monedaExcel = infoCuentaMoneda.textContent.trim();
        let monedaValidacion = null;
        
        // Mapear monedas del Excel a códigos de validación
        if (monedaExcel === 'Soles' || monedaExcel === 'PEN') {
          monedaValidacion = 'PEN';
        } else if (monedaExcel === 'Dólares' || monedaExcel === 'USD') {
          monedaValidacion = 'USD';
        }
        
        if (monedaValidacion) {
          await validarSaldos(movimientos, monedaValidacion);
        } else {
          mostrarValidacionSaldos(`⚠️ Moneda "${monedaExcel}" no reconocida para validación de saldos. Se esperaba "Soles", "Dólares", "PEN" o "USD".`, 'warning');
        }

        // Crear fila de saldo inicial
        const ultimaTransaccion = movimientos[movimientos.length - 1];
        let saldoInicial = '---';
        const fechaInicial = ultimaTransaccion ? ultimaTransaccion.fecha : '---';
        
        if (ultimaTransaccion) {
          // Saldo inicial = saldo de la última fila - monto de la última fila
          const saldoUltima = parseFloat(String(ultimaTransaccion.saldo).replace(/[,\s]/g, '')) || 0;
          const montoUltima = parseFloat(String(ultimaTransaccion.monto).replace(/[,\s]/g, '')) || 0;
          const saldoCalculado = saldoUltima - montoUltima;
          saldoInicial = formatNumber(saldoCalculado);
        }
        
        const filaInicial = document.createElement('tr');
        filaInicial.style.backgroundColor = 'rgba(27, 137, 67, 0.1)';
        filaInicial.style.fontWeight = '600';
        filaInicial.innerHTML = `
          <td class="acciones-column">
            <div class="acciones-container" style="opacity: 0.5;">
              <i class="fas fa-info-circle" style="color: var(--color-principal);"></i>
            </div>
          </td>
          <td>${fechaInicial}</td>
          <td>SALDO INICIAL</td>
          <td>---</td>
          <td class="text-right">---</td>
          <td class="text-right">${saldoInicial}</td>
          <td>---</td>
          <td>---</td>
          <td>---</td>
        `;
        tablaMovimientosBancosBody.appendChild(filaInicial);

        movimientos.forEach((mov, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="acciones-column">
              <div class="acciones-container">
                <button class="btn-accion btn-split" onclick="abrirModalSplit(this)">
                  <i class="fas fa-cut"></i>
                </button>
                <button class="btn-accion btn-delete" onclick="eliminarFila(this)">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
            <td>${mov.fecha}</td>
            <td class="celda-editable" contenteditable="true">${mov.concepto}</td>
            <td class="celda-editable" contenteditable="true">${mov.proveedor}</td>
            <td class="text-right">${formatNumber(mov.monto)}</td>
            <td class="text-right">${mov.saldo}</td>
            <td>${mov.numOperacion}</td>
            <td>${mov.hora}</td>
            <td class="celda-editable celda-referencia" contenteditable="true">${mov.referencia}</td>
          `;
          tablaMovimientosBancosBody.appendChild(tr);
        });

        // Crear fila de saldo final
        const primeraTransaccion = movimientos[0];
        const saldoFinal = primeraTransaccion ? primeraTransaccion.saldo : '---';
        const fechaFinal = primeraTransaccion ? primeraTransaccion.fecha : '---';
        
        const filaFinal = document.createElement('tr');
        filaFinal.style.backgroundColor = 'rgba(27, 137, 67, 0.1)';
        filaFinal.style.fontWeight = '600';
        filaFinal.innerHTML = `
          <td class="acciones-column">
            <div class="acciones-container" style="opacity: 0.5;">
              <i class="fas fa-info-circle" style="color: var(--color-principal);"></i>
            </div>
          </td>
          <td>${fechaFinal}</td>
          <td>SALDO FINAL</td>
          <td>---</td>
          <td class="text-right">---</td>
          <td class="text-right">${saldoFinal}</td>
          <td>---</td>
          <td>---</td>
          <td>---</td>
        `;
        tablaMovimientosBancosBody.appendChild(filaFinal);

        // Habilitar el botón de cargar transacciones
        btnCargarTransacciones.disabled = false;
        estadoCarga.textContent = `${movimientos.length} transacciones listas para enviar`;
      }

      // Función para enviar las transacciones al endpoint
      async function enviarTransacciones() {
        if (movimientosProcesados.length === 0) {
          mostrarResultado('No hay transacciones para enviar', 'error');
          return;
        }

        // Deshabilitar el botón y mostrar estado de carga
        btnCargarTransacciones.disabled = true;
        estadoCarga.textContent = 'Enviando transacciones...';
        resultadoCarga.style.display = 'none';

        try {
          // Leer los datos actuales de la tabla (incluyendo ediciones)
          const filas = tablaMovimientosBancosBody.querySelectorAll('tr');
          
          const fechas = [];
          const conceptos = [];
          const proveedores = [];
          const montos = [];
          const saldos = [];
          const numOperaciones = [];
          const horas = [];
          const referencias = [];

          filas.forEach(fila => {
            const celdas = fila.querySelectorAll('td');
            if (celdas.length >= 9) {
              // Extraer valores de cada celda (saltando la primera que es de acciones)
              fechas.push(celdas[1].textContent.trim() || '---');
              conceptos.push(celdas[2].textContent.trim() || '---');
              proveedores.push(celdas[3].textContent.trim() || '---');
              
              // Para el monto, extraer el número del texto formateado
              const montoTexto = celdas[4].textContent.trim();
              const monto = montoTexto === '---' ? 0 : parseFloat(montoTexto.replace(/[,\s]/g, '')) || 0;
              montos.push(monto);
              
              // Para el saldo, aplicar la misma lógica que el monto
              const saldoTexto = celdas[5].textContent.trim();
              const saldo = saldoTexto === '---' ? 0 : parseFloat(saldoTexto.replace(/[,\s]/g, '')) || 0;
              saldos.push(saldo);
              numOperaciones.push(celdas[6].textContent.trim() || '---');
              horas.push(celdas[7].textContent.trim() || '---');
              referencias.push(celdas[8].textContent.trim() || '---');
            }
          });

          const datosParaEnviar = {
            cuenta_info: `${infoCuentaNumero.textContent},${infoCuentaTipo.textContent}`,
            moneda: infoCuentaMoneda.textContent,
            fechas: fechas.join(','),
            conceptos: conceptos.join(','),
            proveedores: proveedores.join(','),
            montos: montos.join(','),
            saldos: saldos.join(','),
            numOperaciones: numOperaciones.join(','),
            horas: horas.join(','),
            referencias: referencias.join(','),
            timestamp: new Date().toISOString(),
            total_transacciones: fechas.length
          };

          // Enviar al endpoint
          const response = await fetch('https://connect.pabbly.com/workflow/sendwebhookdata/IjU3NjYwNTY4MDYzZTA0MzQ1MjZmNTUzNTUxMzMi_pc', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(datosParaEnviar)
          });

          if (response.ok) {
            const resultado = await response.json();
            mostrarResultado(`✅ Transacciones enviadas exitosamente. ${fechas.length} registros procesados.`, 'success');
            estadoCarga.textContent = 'Enviado correctamente';
          } else {
            throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
          }

        } catch (error) {
          console.error('Error al enviar transacciones:', error);
          mostrarResultado(`❌ Error al enviar transacciones: ${error.message}`, 'error');
          estadoCarga.textContent = 'Error en el envío';
        } finally {
          // Rehabilitar el botón
          btnCargarTransacciones.disabled = false;
        }
      }

      // Función auxiliar para mostrar resultados
      function mostrarResultado(mensaje, tipo) {
        resultadoCarga.textContent = mensaje;
        resultadoCarga.style.display = 'block';
        
        if (tipo === 'success') {
          resultadoCarga.style.backgroundColor = 'rgba(46, 204, 113, 0.1)';
          resultadoCarga.style.color = 'var(--color-success)';
          resultadoCarga.style.border = '1px solid rgba(46, 204, 113, 0.3)';
        } else if (tipo === 'error') {
          resultadoCarga.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
          resultadoCarga.style.color = 'var(--color-danger)';
          resultadoCarga.style.border = '1px solid rgba(231, 76, 60, 0.3)';
        }
      }

      // Event listeners para el modal
      document.getElementById('modal-close').addEventListener('click', cerrarModalSplit);
      document.getElementById('btn-cancel-split').addEventListener('click', cerrarModalSplit);
      document.getElementById('btn-confirm-split').addEventListener('click', confirmarSplit);
      document.getElementById('btn-add-split-line').addEventListener('click', addSplitLine);

      // Cerrar modal al hacer clic fuera
      document.getElementById('split-modal').addEventListener('click', function(e) {
        if (e.target === this) {
          cerrarModalSplit();
        }
      });

    });
  </script>
</body>
</html>