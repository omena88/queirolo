<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carga de Movimientos Bancarios</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- 1. Cargar dependencias (Tailwind, FontAwesome, XLSX, Preline) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Preline UI Script -->
  <script src="https://cdn.jsdelivr.net/npm/preline/dist/preline.js"></script>

  <!-- 2. Configuración de Tailwind -->
  <script>
    tailwind.config = {
      important: '#movimientos-bancarios-app',
      corePlugins: {
        preflight: false,
      },
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            gray: {
              50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 300: '#d1d5db',
              400: '#9ca3af', 500: '#6b7280', 600: '#4b5563', 700: '#374151',
              800: '#1f2937', 900: '#111827',
            }
          }
        }
      }
    }
  </script>

  <!-- 3. Estilos de corrección (CSS Crítico para WordPress) -->
  <style>
    /* Reset local y encapsulamiento */
    #movimientos-bancarios-app {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
      color: #1f2937;
      line-height: 1.5;
      border-radius: 0.5rem;
    }

    /* Reset de caja */
    #movimientos-bancarios-app *,
    #movimientos-bancarios-app *::before,
    #movimientos-bancarios-app *::after {
      box-sizing: border-box;
      border-width: 0;
      border-style: solid;
      border-color: #e5e7eb;
    }

    /* Restaurar inputs */
    #movimientos-bancarios-app input,
    #movimientos-bancarios-app select {
      border-width: 1px;
      outline: 2px solid transparent;
      outline-offset: 2px;
    }

    /* --- CORRECCIÓN DE TABLA PARA WORDPRESS (CRÍTICO) --- */
    /* Forzamos al navegador a ignorar los estilos del tema que rompen la tabla */
    #movimientos-bancarios-app table {
      display: table !important;
      border-collapse: collapse !important;
      width: 100% !important;
      table-layout: auto !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    #movimientos-bancarios-app thead {
      display: table-header-group !important;
    }

    #movimientos-bancarios-app tbody {
      display: table-row-group !important;
    }

    #movimientos-bancarios-app tr {
      display: table-row !important;
      border-bottom: 1px solid #e5e7eb !important;
      background: transparent;
      /* Evita herencia de fondos raros */
    }

    #movimientos-bancarios-app th,
    #movimientos-bancarios-app td {
      display: table-cell !important;
      vertical-align: middle !important;
      padding: 0.75rem !important;
      /* px-3 py-3 aprox */
      border: none !important;
      border-bottom: 1px solid #e5e7eb !important;
    }

    /* Asegurar que el header se quede quieto */
    #movimientos-bancarios-app thead th {
      position: sticky !important;
      top: 0 !important;
      z-index: 10 !important;
      background-color: #f9fafb !important;
      /* bg-gray-50 */
    }

    /* Scrollbar */
    #movimientos-bancarios-app .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    #movimientos-bancarios-app .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    #movimientos-bancarios-app .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    /* Z-Index modal */
    #split-modal {
      z-index: 999999 !important;
    }
  </style>
</head>

<body class="bg-gray-50">

  <!-- 4. Estructura HTML -->
  <div id="movimientos-bancarios-app" class="p-4 md:p-8">

    <div class="mx-auto space-y-6 max-w-[900px]">

      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-3 m-0">
          <i class="fas fa-university text-emerald-500"></i>
          Carga de Movimientos Bancarios
        </h1>
      </div>

      <!-- Cards Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Card 1 -->
        <div class="flex flex-col bg-white border border-gray-200 shadow-sm rounded-xl p-4 md:p-5">
          <div class="flex items-center gap-3 mb-4">
            <span
              class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-emerald-100 text-emerald-500 font-bold text-sm">01</span>
            <h2 class="text-lg font-bold text-gray-800 m-0">Cargar archivo</h2>
          </div>
          <div class="space-y-4">
            <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
              <button id="btn-cargar-bancos"
                class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-emerald-600 text-white hover:bg-emerald-700 transition-all">
                <i class="fas fa-upload"></i> Seleccionar Excel
              </button>
              <input type="file" id="bancos-file-input" accept=".xls,.xlsx,.csv" class="hidden">
              <span id="bancos-nombre-archivo" class="text-sm text-gray-500 italic truncate max-w-[200px]"></span>
            </div>
            <div id="info-cuenta-container"
              class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm text-gray-600 space-y-1 hidden">
              <p class="m-0"><span class="font-semibold text-gray-800">Cuenta:</span> <span
                  id="info-cuenta-numero">---</span></p>
              <p class="m-0"><span class="font-semibold text-gray-800">Moneda:</span> <span
                  id="info-cuenta-moneda">---</span></p>
              <p class="m-0"><span class="font-semibold text-gray-800">Tipo:</span> <span
                  id="info-cuenta-tipo">---</span></p>
            </div>
          </div>
        </div>

        <!-- Card 2 -->
        <div class="flex flex-col bg-white border border-gray-200 shadow-sm rounded-xl p-4 md:p-5">
          <div class="flex items-center gap-3 mb-4">
            <span
              class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-500 font-bold text-sm">02</span>
            <h2 class="text-lg font-bold text-gray-800 m-0">Cargar transacciones</h2>
          </div>
          <div class="space-y-4">
            <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
              <button id="btn-cargar-transacciones"
                class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none transition-all"
                disabled>
                <i class="fas fa-cloud-upload-alt"></i> Enviar Transacciones
              </button>
              <span id="estado-carga" class="text-sm text-gray-500"></span>
            </div>
            <div id="resultado-carga" class="hidden p-4 text-sm rounded-lg" role="alert"></div>
          </div>
        </div>
      </div>

      <!-- Card 3: Tabla -->
      <div class="flex flex-col bg-white border border-gray-200 shadow-sm rounded-xl p-4 md:p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 m-0">
            <i class="fas fa-list-alt text-gray-500"></i> Movimientos Registrados
          </h2>
          <div class="text-sm text-gray-500">
            Total registros: <span id="total-registros" class="font-semibold text-gray-900">0</span>
          </div>
        </div>

        <!-- Contenedor con overflow controlado -->
        <div class="overflow-x-auto custom-scrollbar max-h-[600px] border border-gray-200 rounded-lg bg-white relative">
          <table id="tabla-movimientos-bancos">
            <thead>
              <tr>
                <th scope="col"
                  class="text-left text-xs font-medium text-gray-500 uppercase w-[100px] whitespace-nowrap">Fecha</th>
                <th scope="col" class="text-left text-xs font-medium text-gray-500 uppercase min-w-[200px]">Concepto /
                  Proveedor</th>
                <th scope="col" class="text-right text-xs font-medium text-gray-500 uppercase w-[110px]">Cargo</th>
                <th scope="col" class="text-right text-xs font-medium text-gray-500 uppercase w-[110px]">Abono</th>
                <th scope="col" class="text-right text-xs font-medium text-gray-500 uppercase w-[110px]">Saldo</th>
                <th scope="col" class="text-left text-xs font-medium text-gray-500 uppercase w-[140px]">Referencia / Op.
                </th>
                <th scope="col" class="text-center text-xs font-medium text-gray-500 uppercase w-[90px]">Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-body">
              <!-- Filas inyectadas por JS -->
            </tbody>
          </table>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-10 text-gray-400">
          <i class="fas fa-file-excel text-4xl mb-3 text-gray-300"></i>
          <p>Carga un archivo Excel para visualizar los movimientos</p>
        </div>
      </div>

    </div>

    <!-- Modal de Split -->
    <div id="split-modal" class="fixed inset-0 hidden overflow-x-hidden overflow-y-auto">
      <div class="fixed inset-0 bg-gray-900 bg-opacity-50 transition-opacity backdrop-blur-sm"
        onclick="cerrarModalSplit()"></div>
      <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
        <div
          class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-gray-200">
          <div class="flex justify-between items-center py-3 px-4 border-b border-gray-200 bg-gray-50">
            <h3 class="font-bold text-gray-800 flex items-center gap-2 m-0"><i class="fas fa-cut text-blue-600"></i>
              Dividir Transacción</h3>
            <button type="button" onclick="cerrarModalSplit()"
              class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-200 text-gray-500 transition-all focus:outline-none focus:ring-2 focus:ring-gray-200">
              <i class="fas fa-times text-lg"></i>
            </button>
          </div>
          <div class="p-4 sm:p-6 space-y-5">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 grid grid-cols-2 gap-4 text-sm">
              <div><span class="block text-gray-500 mb-1 font-medium">Monto Original</span><span
                  id="split-original-amount" class="block font-mono font-bold text-gray-800 text-lg">0.00</span></div>
              <div><span class="block text-gray-500 mb-1 font-medium">Concepto</span><span id="split-original-concept"
                  class="block font-medium text-gray-800 truncate">---</span></div>
            </div>
            <div id="split-lines-container" class="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div>
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 space-y-2">
              <div class="flex justify-between text-sm"><span class="text-gray-600">Total Asignado:</span><span
                  id="split-total-assigned" class="font-mono font-bold text-gray-800">0.00</span></div>
              <div class="flex justify-between text-sm pt-2 border-t border-gray-200"><span
                  class="font-medium text-gray-800">Diferencia:</span><span id="split-difference"
                  class="font-mono font-bold">0.00</span></div>
            </div>
          </div>
          <div class="flex justify-between items-center gap-x-2 py-3 px-4 border-t border-gray-200 bg-gray-50">
            <button onclick="addSplitLine()" type="button"
              class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg bg-blue-100 text-blue-800 hover:bg-blue-200"><i
                class="fas fa-plus"></i> Agregar Línea</button>
            <div class="flex gap-2">
              <button onclick="cerrarModalSplit()" type="button"
                class="py-2 px-3 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 hover:bg-gray-50">Cancelar</button>
              <button id="btn-confirm-split" onclick="confirmarSplit()" type="button"
                class="py-2 px-3 text-sm font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
                disabled>Confirmar Split</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lógica JS -->
  <script>
      (function () {
        // Variables Globales Locales
        let currentSplitRow = null, originalAmount = 0, splitLines = [], csvData = [], movimientosProcesados = [];

        // Funciones Helper Globales
        window.formatNumber = function (num, decimals = 2) {
          if (num === undefined || num === null || String(num).trim() === '') return '---';
          const val = Number(num);
          return isNaN(val) ? '---' : val.toLocaleString('es-PE', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        };

        window.eliminarFila = function (boton) {
          const fila = boton.closest('tr');
          if (confirm('¿Eliminar transacción?')) {
            fila.style.opacity = '0';
            setTimeout(() => {
              fila.remove();
              const count = document.getElementById('tabla-body').rows.length;
              document.getElementById('total-registros').textContent = count;
              document.getElementById('estado-carga').textContent = `${count} transacciones listas`;
              if (count === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('btn-cargar-transacciones').disabled = true;
              }
            }, 300);
          }
        };

        // Funciones Split Modal
        window.abrirModalSplit = function (btn) {
          const row = btn.closest('tr');
          currentSplitRow = row;
          const cells = row.querySelectorAll('td');
          const concepto = cells[1].querySelector('div:first-child')?.textContent.trim() || '---';
          const cargo = cells[2].textContent.trim(), abono = cells[3].textContent.trim();

          let monto = 0;
          if (cargo !== '-') monto = parseFloat(cargo.replace(/[,\s]/g, '')) * -1;
          else if (abono !== '-') monto = parseFloat(abono.replace(/[,\s]/g, ''));

          originalAmount = monto;
          document.getElementById('split-original-concept').textContent = concepto;
          document.getElementById('split-original-amount').textContent = formatNumber(originalAmount);
          splitLines = [{ concepto: concepto, monto: originalAmount / 2 }, { concepto: '', monto: originalAmount / 2 }];
          renderSplitLines();
          updateSplitTotals();
          document.getElementById('split-modal').classList.remove('hidden');
        };

        window.renderSplitLines = function () {
          const cont = document.getElementById('split-lines-container');
          cont.innerHTML = '';
          splitLines.forEach((l, i) => {
            const div = document.createElement('div');
            div.className = 'grid grid-cols-12 gap-3 items-center';
            div.innerHTML = `
                    <div class="col-span-6"><input type="text" placeholder="Concepto" value="${l.concepto}" class="py-2 px-3 block w-full border-gray-200 rounded-lg text-sm bg-gray-50" onchange="updateSplitLine(${i}, 'concepto', this.value)"></div>
                    <div class="col-span-5"><input type="number" step="0.01" placeholder="Monto" value="${l.monto}" class="py-2 px-3 block w-full border-gray-200 rounded-lg text-sm bg-gray-50" onchange="updateSplitLine(${i}, 'monto', parseFloat(this.value)||0)"></div>
                    <div class="col-span-1 text-center"><button class="text-red-500 hover:text-red-700 ${splitLines.length <= 2 ? 'invisible' : ''}" onclick="removeSplitLine(${i})"><i class="fas fa-times"></i></button></div>
                `;
            cont.appendChild(div);
          });
        };

        window.updateSplitLine = function (i, f, v) { if (splitLines[i]) { splitLines[i][f] = v; updateSplitTotals(); } };
        window.removeSplitLine = function (i) { if (splitLines.length > 2) { splitLines.splice(i, 1); renderSplitLines(); updateSplitTotals(); } };
        window.addSplitLine = function () { splitLines.push({ concepto: '', monto: 0 }); renderSplitLines(); updateSplitTotals(); };
        window.cerrarModalSplit = function () { document.getElementById('split-modal').classList.add('hidden'); currentSplitRow = null; splitLines = []; };

        window.updateSplitTotals = function () {
          const total = splitLines.reduce((s, l) => s + (l.monto || 0), 0);
          const diff = originalAmount - total;
          document.getElementById('split-total-assigned').textContent = formatNumber(total);
          const diffEl = document.getElementById('split-difference');
          diffEl.textContent = formatNumber(diff);
          const ok = Math.abs(diff) < 0.01;
          diffEl.className = `font-mono font-bold ${ok ? 'text-emerald-600' : 'text-red-600'}`;
          document.getElementById('btn-confirm-split').disabled = !ok;
        };

        window.confirmarSplit = function () {
          if (!currentSplitRow || Math.abs(originalAmount - splitLines.reduce((s, l) => s + (l.monto || 0), 0)) >= 0.01) return;
          const cells = currentSplitRow.querySelectorAll('td');
          const fecha = cells[0].textContent.trim();
          const prov = cells[1].querySelector('div:nth-child(2)')?.textContent.trim() || '---';
          const saldo = cells[4].textContent.trim();
          const ref = cells[5].querySelector('div:first-child')?.textContent.trim() || '---';
          const op = cells[5].querySelector('div:nth-child(2)')?.textContent.replace('Op: ', '').trim() || '---';

          currentSplitRow.remove();
          const tbody = document.getElementById('tabla-body');

          splitLines.forEach(l => {
            if (l.concepto.trim() !== '' && l.monto !== 0) {
              const tr = document.createElement('tr');
              tr.className = 'bg-white hover:bg-gray-50 border-b border-gray-200';
              tr.innerHTML = `
                        <td class="whitespace-nowrap text-gray-900 text-sm align-middle">${fecha}</td>
                        <td class="text-sm text-gray-900 align-middle">
                            <div class="font-medium" contenteditable="true">${l.concepto}</div>
                            <div class="text-xs text-gray-500" contenteditable="true">${prov}</div>
                        </td>
                        <td class="text-right text-sm align-middle whitespace-nowrap ${l.monto < 0 ? 'text-red-600' : 'text-gray-400'}">${l.monto < 0 ? formatNumber(Math.abs(l.monto)) : '-'}</td>
                        <td class="text-right text-sm align-middle whitespace-nowrap ${l.monto >= 0 ? 'text-emerald-600' : 'text-gray-400'}">${l.monto >= 0 ? formatNumber(l.monto) : '-'}</td>
                        <td class="text-right text-gray-900 font-medium text-sm align-middle whitespace-nowrap">${saldo}</td>
                        <td class="text-sm align-middle">
                            <div class="text-gray-600 text-xs leading-tight" contenteditable="true">${ref}</div>
                            <div class="text-gray-400 text-[10px]">Op: ${op}</div>
                        </td>
                        <td class="text-center align-middle whitespace-nowrap">
                            <div class="flex justify-center gap-2">
                                <button class="w-8 h-8 flex items-center justify-center bg-white border border-gray-200 shadow-sm rounded-lg text-gray-600 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-600 transition-all" onclick="abrirModalSplit(this)" title="Dividir">
                                  <i class="fas fa-cut"></i>
                                </button>
                                <button class="w-8 h-8 flex items-center justify-center bg-white border border-gray-200 shadow-sm rounded-lg text-gray-600 hover:bg-red-50 hover:border-red-200 hover:text-red-600 transition-all" onclick="eliminarFila(this)" title="Eliminar">
                                  <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
              tbody.appendChild(tr);
            }
          });
          const count = tbody.rows.length;
          document.getElementById('total-registros').textContent = count;
          document.getElementById('estado-carga').textContent = `${count} transacciones listas`;
          cerrarModalSplit();
        };

        // Funciones CSV y Excel
        async function cargarCSV() {
          const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRKeFI1f8VGIlLuN_yPSctoqlyrAUiSU7TwYIXiUs1X83gIWSnwprTN50AZ_hKSzmcigHxOXiQGoUTl/pub?gid=0&single=true&output=csv';
          const proxies = [u => `https://corsproxy.io/?${encodeURIComponent(u)}`, u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`];
          for (const p of proxies) {
            try {
              const r = await fetch(p(url));
              if (!r.ok) throw new Error(r.status);
              const t = await r.text();
              const lines = t.split('\n'), h = lines[0].split(',');
              csvData = lines.slice(1).map(l => {
                const d = parseCSVLine(l);
                if (d.length < h.length) return null;
                const obj = {}; h.forEach((k, i) => obj[k.trim()] = d[i]?.trim() || ''); return obj;
              }).filter(x => x);
              return;
            } catch (e) { console.warn(e); }
          }
          alert('Error cargando referencias CSV. Revise conexión.');
        }

        function parseCSVLine(l) {
          const r = []; let c = '', q = false;
          for (let i = 0; i < l.length; i++) {
            if (l[i] === '"') q = !q;
            else if (l[i] === ',' && !q) { r.push(c); c = ''; }
            else c += l[i];
          }
          r.push(c); return r;
        }

        function handleFile(e) {
          const f = e.target.files[0];
          if (!f) return;
          document.getElementById('bancos-nombre-archivo').textContent = f.name;
          const r = new FileReader();
          r.onload = function (evt) {
            const wb = XLSX.read(evt.target.result, { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
            if (json.length < 6) { alert('Archivo inválido'); return; }

            const mapa = { 'Soles': 'PEN', 'Dólares': 'USD', 'PEN': 'PEN', 'USD': 'USD' };
            const acct = String(json[0][1] || ''), curRaw = String(json[1][1] || '').trim();
            document.getElementById('info-cuenta-numero').textContent = acct;
            document.getElementById('info-cuenta-moneda').textContent = curRaw;
            document.getElementById('info-cuenta-tipo').textContent = String(json[2][1] || '');

            let curCode = mapa[curRaw];
            if (!curCode) curCode = curRaw.toUpperCase().includes('SOL') ? 'PEN' : (curRaw.toUpperCase().includes('DOL') ? 'USD' : curRaw);

            const movs = [];
            for (let i = 5; i < json.length; i++) {
              const row = json[i];
              if (!row || (!row[0] && !row[3])) continue;

              const fechaRaw = row[0], desc = String(row[2] || ''), monto = row[3], saldo = row[4], hora = row[7], ref2 = String(row[10] || '');
              let op = String(row[6] || '');

              if (desc.toUpperCase().includes('TRANFERENCIA CCE')) {
                const idx4 = String(op).indexOf('4');
                if (idx4 !== -1) op = String(op).substring(0, idx4) + '2' + String(op).substring(idx4 + 1);
              }

              // Match CSV
              let match = null;
              if (op && op !== '---') {
                for (const c of csvData) {
                  if (String(c['tipo_operación'] || '').trim().toLowerCase() !== 'egreso') continue;
                  if (curCode && String(c['moneda'] || '').trim() !== curCode) continue;
                  if (String(op).endsWith(String(c['número_operación'] || '').trim())) { match = c; break; }
                }
              }

              let concepto = desc, prov = '---', ref = ref2;
              const descUp = desc.toUpperCase();

              if (descUp.includes('TRANSF.EXT') && match) { concepto = match['referencia']; prov = match['empresa_destino']; ref = match['mensaje']; }
              else if (['IMPUESTO', 'COM.MANTENIM', 'ENVIO.EST.CTA', 'COM.OP'].some(x => descUp.startsWith(x))) { ref = desc; concepto = 'COMISION BANCARIA'; }
              else if (descUp.startsWith('HABER')) concepto = 'PLANILLA';
              else if (descUp.startsWith('BACK')) { concepto = 'BACKUS'; prov = 'BACKUS'; }
              else if (descUp.startsWith('PAGO IMPUES')) prov = 'SUNAT';
              else if (match) { concepto = match['referencia']; prov = match['empresa_destino']; ref = match['mensaje']; }

              let finalMonto = monto;
              if ((descUp.includes('TRANFERENCIA CCE') || descUp.includes('TRANSF.EXT')) && match) finalMonto = Number(match['monto_neto']) || monto;

              const fmtDate = (v) => {
                if (typeof v === 'number') { const d = XLSX.SSF.parse_date_code(v); return `${String(d.d).padStart(2, '0')}/${String(d.m).padStart(2, '0')}/${d.y}`; }
                return v || '---';
              };
              const fmtNum = (v) => { const n = Number(v); return isNaN(n) ? '---' : n.toLocaleString('es-PE', { minimumFractionDigits: 2 }).replace(/,/g, ' '); };

              movs.push({
                f: fmtDate(fechaRaw), c: concepto, p: prov, m: finalMonto,
                s: fmtNum(saldo), op: op || '---', r: ref
              });

              if ((descUp.includes('TRANSF.EXT') || descUp.includes('TRANFERENCIA CCE')) && match) {
                const com = (Number(monto) || 0) - (Number(match['monto_neto']) || 0);
                movs.push({
                  f: fmtDate(fechaRaw), c: 'COMISION BANCARIA', p: prov, m: com,
                  s: fmtNum(saldo), op: op || '---', r: fmtNum(monto)
                });
              }
            }
            movimientosProcesados = movs;
            renderTable(movs);
          };
          r.readAsArrayBuffer(f);
        }

        function renderTable(data) {
          const tb = document.getElementById('tabla-body');
          tb.innerHTML = '';
          if (!data.length) { tb.innerHTML = '<tr><td colspan="7" class="text-center py-4">Sin datos</td></tr>'; return; }

          data.forEach(m => {
            const tr = document.createElement('tr');
            tr.className = 'bg-white hover:bg-gray-50 border-b border-gray-200';
            tr.innerHTML = `
                    <td class="whitespace-nowrap text-gray-900 text-sm align-middle">${m.f}</td>
                    <td class="text-sm text-gray-900 align-middle">
                        <div class="font-medium" contenteditable="true">${m.c}</div>
                        <div class="text-xs text-gray-500" contenteditable="true">${m.p}</div>
                    </td>
                    <td class="text-right text-sm align-middle whitespace-nowrap ${m.m < 0 ? 'text-red-600' : 'text-gray-400'}">${m.m < 0 ? formatNumber(Math.abs(m.m)) : '-'}</td>
                    <td class="text-right text-sm align-middle whitespace-nowrap ${m.m >= 0 ? 'text-emerald-600' : 'text-gray-400'}">${m.m >= 0 ? formatNumber(m.m) : '-'}</td>
                    <td class="text-right text-gray-900 font-medium text-sm align-middle whitespace-nowrap">${m.s}</td>
                    <td class="text-sm align-middle">
                        <div class="text-gray-600 text-xs leading-tight" contenteditable="true">${m.r}</div>
                        <div class="text-gray-400 text-[10px]">Op: ${m.op}</div>
                    </td>
                    <td class="text-center align-middle whitespace-nowrap">
                        <div class="flex justify-center gap-2">
                            <button class="w-8 h-8 flex items-center justify-center bg-white border border-gray-200 shadow-sm rounded-lg text-gray-600 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-600 transition-all" onclick="abrirModalSplit(this)" title="Dividir">
                              <i class="fas fa-cut"></i>
                            </button>
                            <button class="w-8 h-8 flex items-center justify-center bg-white border border-gray-200 shadow-sm rounded-lg text-gray-600 hover:bg-red-50 hover:border-red-200 hover:text-red-600 transition-all" onclick="eliminarFila(this)" title="Eliminar">
                              <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
            tb.appendChild(tr);
          });
          document.getElementById('total-registros').textContent = data.length;
          document.getElementById('estado-carga').textContent = `${data.length} transacciones listas`;
          document.getElementById('btn-cargar-transacciones').disabled = false;
          document.getElementById('empty-state').classList.add('hidden');
          document.getElementById('info-cuenta-container').classList.remove('hidden');
        }

        async function enviarTransacciones() {
          if (!movimientosProcesados.length) return;
          const btn = document.getElementById('btn-cargar-transacciones');
          btn.disabled = true; document.getElementById('estado-carga').textContent = 'Enviando...';

          try {
            const rows = document.getElementById('tabla-body').querySelectorAll('tr');
            const data = { fechas: [], conceptos: [], proveedores: [], montos: [], saldos: [], ops: [], refs: [] };
            rows.forEach(r => {
              const c = r.querySelectorAll('td');
              data.fechas.push(c[0].textContent);
              data.conceptos.push(c[1].querySelector('div:first-child')?.textContent || '');
              data.proveedores.push(c[1].querySelector('div:nth-child(2)')?.textContent || '');
              const cargo = c[2].textContent, abono = c[3].textContent;
              let m = 0;
              if (cargo !== '-') m = parseFloat(cargo.replace(/[,\s]/g, '')) * -1;
              else if (abono !== '-') m = parseFloat(abono.replace(/[,\s]/g, ''));
              data.montos.push(m);
              data.saldos.push(parseFloat(c[4].textContent.replace(/[,\s]/g, '')) || 0);
              data.refs.push(c[5].querySelector('div:first-child')?.textContent || '');
              data.ops.push(c[5].querySelector('div:nth-child(2)')?.textContent.replace('Op: ', '') || '');
            });

            const payload = {
              cuenta_info: document.getElementById('info-cuenta-numero').textContent,
              moneda: document.getElementById('info-cuenta-moneda').textContent,
              fechas: data.fechas.join(','), conceptos: data.conceptos.join(','), proveedores: data.proveedores.join(','),
              montos: data.montos.join(','), saldos: data.saldos.join(','), numOperaciones: data.ops.join(','),
              referencias: data.refs.join(','), timestamp: new Date().toISOString()
            };

            await fetch('https://connect.pabbly.com/workflow/sendwebhookdata/IjU3NjYwNTY4MDYzZTA0MzQ1MjZmNTUzNTUxMzMi_pc', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            mostrarRes('Enviado correctamente', 'success');
          } catch (e) {
            mostrarRes('Error al enviar', 'error');
          } finally { btn.disabled = false; }
        }

        function mostrarRes(msg, type) {
          const el = document.getElementById('resultado-carga');
          el.textContent = msg; el.className = `p-4 mb-4 text-sm rounded-lg border ${type === 'success' ? 'bg-green-50 text-green-800 border-green-200' : 'bg-red-50 text-red-800 border-red-200'}`;
          el.classList.remove('hidden');
        }

        // Init
        const btn = document.getElementById('btn-cargar-bancos');
        if (btn) btn.addEventListener('click', () => document.getElementById('bancos-file-input').click());
        document.getElementById('bancos-file-input').addEventListener('change', handleFile);
        document.getElementById('btn-cargar-transacciones').addEventListener('click', enviarTransacciones);
        cargarCSV();
      })();
  </script>
</body>

</html>