<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reporte bancos semanal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Librerías externas CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Estilos -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
      /* Paleta basada en los colores corporativos proporcionados */
      --color-principal: #1b8943;      /* Verde corporativo */
      --color-principal-hover: #157235; /* Verde más oscuro */
      --color-secundario: #a98f43;     /* Dorado/Marrón corporativo */
      --color-secundario-hover: #8f7a39; /* Dorado más oscuro */
      
      /* Colores complementarios */
      --color-success: #2ecc71;        /* Verde éxito */
      --color-warning: #e67e22;        /* Naranja advertencia */
      --color-danger: #e74c3c;         /* Rojo peligro */
      
      /* Fondos y superficies - más oscuros para un tema más elegante */
      --color-fondo: #f5f5f5;          /* Fondo general más oscuro */
      --color-superficie: #ffffff;     /* Blanco para tarjetas */
      --color-superficie-alt: #edf2ed; /* Fondo alternativo con tono verde suave */
      --color-superficie-sec: #f5f2e6; /* Fondo alternativo con tono dorado suave */
      
      /* Textos */
      --color-texto: #333333;          /* Texto principal casi negro */
      --color-texto-secundario: #666666; /* Texto secundario gris oscuro */
      --color-texto-claro: #ffffff;    /* Texto claro/blanco */
      
      /* Bordes y separadores */
      --color-borde: #e0e0e0;          /* Borde claro */
      --color-borde-enfasis: #cccccc;  /* Borde con énfasis */
      
      /* Sombras */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.1);
      --shadow-md: 0 2px 4px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-lg: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
      
      /* Bordes redondeados */
      --border-radius-sm: 4px;
      --border-radius: 6px;
      --border-radius-lg: 8px;
      
      /* Espaciado */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 24px;
      --spacing-xxl: 32px;
      
      font-size: 16px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: var(--color-fondo);
      color: var(--color-texto);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }

    /* Contenedor principal */
    .reporte-container {
      max-width: 100%;
      width: 1380px;
      margin: 0 auto;
      padding: var(--spacing-lg);
      box-sizing: border-box;
    }

    /* Cabecera con estilo dashboard moderno */
    .titulo-reporte {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-xl);
    }
    
    .titulo-reporte h1 {
      color: var(--color-texto);
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .titulo-reporte h1 i {
      color: var(--color-principal);
    }
    
    #fecha-reporte {
      display: inline-block;
      background-color: var(--color-superficie-alt);
      color: var(--color-texto-secundario);
      padding: 6px var(--spacing-md);
      border-radius: 30px;
      font-size: 13px;
      font-weight: 500;
    }

    /* Card para acordeón de configuración */
    .config-accordion {
      background-color: var(--color-superficie);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--spacing-xl);
      overflow: hidden;
      border: 1px solid var(--color-borde);
      transition: box-shadow 0.3s ease;
    }
    
    .config-accordion:hover {
      box-shadow: var(--shadow-md);
    }
    
    .accordion-header {
      background-color: var(--color-superficie);
      padding: var(--spacing-md) var(--spacing-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }
    
    .accordion-header:hover {
      background-color: var(--color-superficie-alt);
    }
    
    .accordion-header h3 {
      color: var(--color-texto);
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .accordion-header h3 i {
      color: var(--color-principal);
    }
    
    .accordion-header i.fas.fa-chevron-down {
      color: var(--color-texto-secundario);
      transition: transform 0.3s ease;
      font-size: 13px;
    }
    
    .accordion-header.active i.fas.fa-chevron-down {
      transform: rotate(180deg);
    }
    
    .accordion-content {
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }
    
    .accordion-content.active {
      padding: var(--spacing-lg);
      max-height: 500px;
    }

    /* Grid para configuración */
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--spacing-lg);
    }
    
    .config-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }
    
    .config-label {
      color: var(--color-texto);
      font-weight: 500;
      font-size: 13px;
      margin-bottom: var(--spacing-xs);
    }
    
    .config-controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      width: 100%;
    }

    /* Inputs y selects estilizados */
    .styled-selector,
    input[type="text"],
    input[type="number"] {
      background-color: var(--color-superficie);
      border: 1px solid var(--color-borde);
      color: var(--color-texto);
      padding: 8px var(--spacing-md);
      border-radius: var(--border-radius-sm);
      font-family: inherit;
      font-size: 13px;
      flex-grow: 1;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      min-width: 80px;
      outline: none;
    }
    
    .styled-selector:focus,
    input[type="text"]:focus,
    input[type="number"]:focus {
      border-color: var(--color-principal);
      box-shadow: 0 0 0 3px rgba(27, 137, 67, 0.15);
    }
    
    #year-selector { flex-grow: 0.5; min-width: 90px; }
    #month-selector { flex-grow: 1; min-width: 120px; }
    #week-selector { flex-grow: 1.5; min-width: 200px; }
    #currency-selector { flex-grow: 1; min-width: 120px; }

    /* Botones modernos */
    .btn {
      background-color: var(--color-principal);
      color: white;
      border: none;
      padding: 8px var(--spacing-md);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-family: inherit;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      white-space: nowrap;
      box-shadow: var(--shadow-sm);
    }
    
    .btn:hover:not(:disabled) {
      background-color: var(--color-principal-hover);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    
    .btn:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }
    
    .btn:disabled {
      background-color: var(--color-texto-secundario);
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: none;
    }
    
    .btn i {
      font-size: 13px;
    }

    /* Secciones y cards */
    .seccion {
      margin-bottom: var(--spacing-xl);
    }
    
    .seccion-title {
      color: var(--color-texto);
      margin-bottom: var(--spacing-md);
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .reporte-compras-container, 
    .reporte-inferior-grid > div {
      background-color: var(--color-superficie);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.3s ease;
      overflow: hidden;
      border: 1px solid var(--color-borde);
      max-width: 100%;
    }
    
    .reporte-compras-container:hover,
    .reporte-inferior-grid > div:hover {
      box-shadow: var(--shadow-md);
    }

    /* Contenedor de tabla con cabecera y padding */
    .reporte-tabla-container {
      width: 100%;
      position: relative;
      overflow: hidden;
    }
    
    .tabla-header {
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--color-borde);
      background-color: var(--color-superficie);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .tabla-header h3 {
      font-size: 15px;
      font-weight: 600;
      color: var(--color-texto);
      margin: 0;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .tabla-header h3 i {
      color: var(--color-principal);
    }
    
    .tabla-body {
      padding: 0;
      overflow: hidden;
    }

    /* Tablas modernas */
    .reporte-tabla {
      width: 100% !important;
      max-width: none !important;
      border-collapse: separate;
      border-spacing: 0;
      margin: 0;
      table-layout: auto;
      position: relative;
      border-radius: var(--border-radius);
      overflow: hidden;
    }
    
    .reporte-tabla th {
      background-color: var(--color-superficie-alt);
      color: var(--color-texto);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      font-size: 12px;
      white-space: normal;
      word-wrap: break-word;
      hyphens: auto;
      vertical-align: middle;
      height: auto;
      min-height: 50px;
      text-align: center;
      padding: 10px 8px;
    }
    
    .reporte-tabla th, 
    .reporte-tabla td {
      position: relative;
      border-bottom: 1px solid var(--color-borde);
    }
    
    .reporte-tabla td {
      white-space: nowrap;
      text-align: right;
      padding: 10px 8px;
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Sistema de sombreado de filas */
    .reporte-tabla tr:hover td,
    .reporte-tabla tr:hover th {
      background-color: rgba(27, 137, 67, 0.15);
    }
    
    .reporte-tabla tbody tr {
      border-bottom: 1px solid var(--color-borde);
      transition: background-color 0.2s ease;
    }
    
    .reporte-tabla tbody tr:last-child {
      border-bottom: none;
    }
    
    .reporte-tabla .column-fecha {
      font-weight: 600;
      text-align: left;
      position: sticky;
      left: 0;
      background-color: var(--color-superficie);
      z-index: 5;
      border-right: 1px solid var(--color-borde);
    }
    
    .reporte-tabla tbody tr:hover .column-fecha {
      background-color: rgba(27, 137, 67, 0.15);
    }
    
    .reporte-tabla .fila-total {
      font-weight: 700;
      background-color: var(--color-superficie-alt);
      color: var(--color-principal);
    }
    
    .reporte-tabla .fila-total .column-fecha {
      background-color: var(--color-superficie-alt);
    }

    /* Estilos para los pasos de configuración */
    .config-steps-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--spacing-lg);
      margin-top: var(--spacing-sm);
    }
    
    .config-step {
      background-color: var(--color-superficie);
      border: 1px solid var(--color-borde);
      border-radius: var(--border-radius);
      padding: var(--spacing-md);
      transition: all 0.2s ease;
    }
    
    .config-step:hover {
      box-shadow: var(--shadow-sm);
      border-color: var(--color-borde-enfasis);
    }
    
    .step-header {
      display: flex;
      align-items: center;
      margin-bottom: var(--spacing-md);
      gap: var(--spacing-sm);
    }
    
    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background-color: var(--color-principal);
      color: white;
      border-radius: 50%;
      font-size: 13px;
      font-weight: 600;
    }
    
    .step-header h4 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--color-texto);
    }
    
    .step-content {
      padding-left: 0;
    }
    
    .step-placeholder {
      color: var(--color-texto-secundario);
      font-style: italic;
      font-size: 13px;
      margin: 0;
      text-align: center;
    }
    
    .config-step.future {
      background-color: var(--color-superficie-alt);
      opacity: 0.75;
    }
    
    .config-step.future .step-number {
      background-color: var(--color-texto-secundario);
    }
    
    .config-step.active {
      border-color: var(--color-principal);
      box-shadow: 0 0 0 1px var(--color-principal);
    }

    .config-step.completed {
      border-color: var(--color-success);
      background-color: rgba(46, 204, 113, 0.05);
    }

    .config-step.completed .step-number {
      background-color: var(--color-success);
    }

    /* Detalle de egresos */
    .detalle-egresos {
      margin-top: var(--spacing-xl);
    }

    .detalle-dia {
      background-color: var(--color-superficie);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--spacing-lg);
      overflow: hidden;
      border: 1px solid var(--color-borde);
    }

    .detalle-dia-header {
      background-color: var(--color-superficie-alt);
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--color-borde);
    }

    .detalle-dia-header h4 {
      color: var(--color-texto);
      font-size: 14px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .detalle-dia-header h4 i {
      color: var(--color-principal);
    }

    .detalle-tabla {
      width: 100%;
      border-collapse: collapse;
    }

    .detalle-tabla th {
      background-color: var(--color-superficie-alt);
      color: var(--color-texto);
      font-weight: 600;
      text-align: left;
      padding: var(--spacing-md);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .detalle-tabla td {
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--color-borde);
      font-size: 12px;
    }

    .detalle-tabla tbody tr:hover {
      background-color: rgba(27, 137, 67, 0.05);
    }

    .detalle-tabla tbody tr:last-child td {
      border-bottom: none;
    }

    .detalle-tabla td:last-child {
      text-align: right;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .reporte-container {
        padding: var(--spacing-md);
      }
      
      .titulo-reporte {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-md);
      }
      
      .config-steps-grid {
        grid-template-columns: 1fr;
      }
      
      .reporte-tabla th, 
      .reporte-tabla td {
        padding: 6px 4px;
        font-size: 11px;
      }
      
      .seccion-title {
        font-size: 15px;
      }
    }

    /* Responsive para pasos */
    @media (max-width: 1200px) {
      .config-steps-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- Contenido del Body -->
  <div class="reporte-container">
    <!-- Título del reporte -->
    <div class="titulo-reporte">
      <h1><i class="fas fa-shopping-cart"></i> Reporte bancos semanal</h1>
      <span id="fecha-reporte">-- Seleccionar periodo --</span>
    </div>
    
    <!-- Acordeón de configuración -->
    <div class="config-accordion">
      <div class="accordion-header" id="accordion-toggle">
        <h3><i class="fas fa-sliders-h"></i> Configuración</h3>
        <i class="fas fa-chevron-down" id="accordion-icon"></i>
      </div>
      <div class="accordion-content active" id="config-content">
         <!-- Pasos en grid de 3 columnas -->
         <div class="config-steps-grid">
           <!-- Paso 01 -->
           <div class="config-step active">
             <div class="step-header">
               <div class="step-number">01</div>
               <h4>Seleccionar semana</h4>
             </div>
             <div class="step-content">
               <div class="config-controls">
                 <select id="year-selector" class="styled-selector">
                   <option value="">Año</option>
                   <option value="2025">2025</option>
                   <option value="2026">2026</option>
                 </select>
                 <select id="month-selector" class="styled-selector">
                   <option value="">Mes</option>
                 </select>
                 <select id="week-selector" class="styled-selector">
                   <option value="">Semana</option>
                 </select>
               </div>
             </div>
           </div>
           
           <!-- Paso 02 -->
           <div class="config-step active">
             <div class="step-header">
               <div class="step-number">02</div>
               <h4>Seleccionar moneda y cargar datos</h4>
             </div>
             <div class="step-content">
               <div class="config-controls" style="flex-direction: column; gap: var(--spacing-md);">
                 <select id="currency-selector" class="styled-selector">
                   <option value="">Seleccionar moneda</option>
                   <option value="PEN" data-url="https://docs.google.com/spreadsheets/d/e/2PACX-1vRRhWBlTXTz5h_v8OIH-3LrKdc6tjqLR15ZG1LlxsFRbZ6867Rn0L3jnWYOUtH6Cv-LQ7QRpULms8ah/pub?gid=0&single=true&output=csv">PEN</option>
                   <option value="USD" data-url="https://docs.google.com/spreadsheets/d/e/2PACX-1vS9bRPb-3jZj8mBz7Al-4p39nG2ua3WWgva9ieg46GvH9jAg2AYk5oSXpEW1H0lWXEJCFZgSnhCv3z3/pub?gid=0&single=true&output=csv">USD</option>
                 </select>
                 <button id="btn-cargar-datos" class="btn" disabled>
                   <i class="fas fa-download"></i> Cargar datos
                 </button>
               </div>
             </div>
           </div>

           <!-- Paso 03 -->
           <div class="config-step future">
             <div class="step-header">
               <div class="step-number">03</div>
               <h4>Generar reporte PDF</h4>
             </div>
             <div class="step-content">
               <div class="config-controls">
                 <button id="btn-generar-pdf" class="btn" disabled>
                   <i class="fas fa-file-pdf"></i> Generar PDF
                 </button>
               </div>
             </div>
           </div>
         </div>
      </div>
    </div>
    
    <!-- SECCIÓN PRINCIPAL: Tabla de Resumen por día -->
    <div class="seccion reporte-compras-container">
      <div class="tabla-header">
        <h3><i class="fas fa-table"></i> Resumen por día</h3>
      </div>
      <div class="tabla-body">
        <div class="reporte-tabla-container">
          <table class="reporte-tabla" id="tabla-resumen">
            <thead>
              <tr>
                <th>Día de la semana</th>
                <th>Compra soles/dólares</th>
                <th>Ingresos</th>
                <th>Egresos</th>
                <th>Saldo</th>
              </tr>
            </thead>
            <tbody>
              <!-- Filas de placeholder -->
              <tr data-date="lunes">
                <th class="column-fecha">Lunes</th>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
              </tr>
              <tr data-date="martes">
                <th class="column-fecha">Martes</th>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
              </tr>
              <tr data-date="miercoles">
                <th class="column-fecha">Miércoles</th>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
              </tr>
              <tr data-date="jueves">
                <th class="column-fecha">Jueves</th>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
              </tr>
              <tr data-date="viernes">
                <th class="column-fecha">Viernes</th>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
              </tr>
              <tr data-date="sabado">
                <th class="column-fecha">Sábado</th>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
              </tr>
              <tr data-date="domingo">
                <th class="column-fecha">Domingo</th>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
              </tr>
              <!-- Fila de total -->
              <tr class="fila-total">
                <th class="column-fecha">TOTAL</th>
                <td>--</td>
                <td>--</td>
                <td>--</td>
                <td>--</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SECCIÓN DETALLE: Detalle de egresos por día -->
    <div class="seccion detalle-egresos">
      
      <!-- Lunes -->
      <div class="detalle-dia" id="detalle-lunes">
        <div class="detalle-dia-header">
          <h4><i class="fas fa-calendar-day"></i> Lunes - --/--/----</h4>
        </div>
        <div class="tabla-body">
          <table class="detalle-tabla">
            <thead>
              <tr>
                <th>Concepto</th>
                <th>Proveedor</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3" style="text-align: center; color: var(--color-texto-secundario); font-style: italic;">
                  No hay datos disponibles
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Martes -->
      <div class="detalle-dia" id="detalle-martes">
        <div class="detalle-dia-header">
          <h4><i class="fas fa-calendar-day"></i> Martes - --/--/----</h4>
        </div>
        <div class="tabla-body">
          <table class="detalle-tabla">
            <thead>
              <tr>
                <th>Concepto</th>
                <th>Proveedor</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3" style="text-align: center; color: var(--color-texto-secundario); font-style: italic;">
                  No hay datos disponibles
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Miércoles -->
      <div class="detalle-dia" id="detalle-miercoles">
        <div class="detalle-dia-header">
          <h4><i class="fas fa-calendar-day"></i> Miércoles - --/--/----</h4>
        </div>
        <div class="tabla-body">
          <table class="detalle-tabla">
            <thead>
              <tr>
                <th>Concepto</th>
                <th>Proveedor</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3" style="text-align: center; color: var(--color-texto-secundario); font-style: italic;">
                  No hay datos disponibles
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Jueves -->
      <div class="detalle-dia" id="detalle-jueves">
        <div class="detalle-dia-header">
          <h4><i class="fas fa-calendar-day"></i> Jueves - --/--/----</h4>
        </div>
        <div class="tabla-body">
          <table class="detalle-tabla">
            <thead>
              <tr>
                <th>Concepto</th>
                <th>Proveedor</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3" style="text-align: center; color: var(--color-texto-secundario); font-style: italic;">
                  No hay datos disponibles
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Viernes -->
      <div class="detalle-dia" id="detalle-viernes">
        <div class="detalle-dia-header">
          <h4><i class="fas fa-calendar-day"></i> Viernes - --/--/----</h4>
        </div>
        <div class="tabla-body">
          <table class="detalle-tabla">
            <thead>
              <tr>
                <th>Concepto</th>
                <th>Proveedor</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3" style="text-align: center; color: var(--color-texto-secundario); font-style: italic;">
                  No hay datos disponibles
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Sábado -->
      <div class="detalle-dia" id="detalle-sabado">
        <div class="detalle-dia-header">
          <h4><i class="fas fa-calendar-day"></i> Sábado - --/--/----</h4>
        </div>
        <div class="tabla-body">
          <table class="detalle-tabla">
            <thead>
              <tr>
                <th>Concepto</th>
                <th>Proveedor</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3" style="text-align: center; color: var(--color-texto-secundario); font-style: italic;">
                  No hay datos disponibles
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Domingo -->
      <div class="detalle-dia" id="detalle-domingo">
        <div class="detalle-dia-header">
          <h4><i class="fas fa-calendar-day"></i> Domingo - --/--/----</h4>
        </div>
        <div class="tabla-body">
          <table class="detalle-tabla">
            <thead>
              <tr>
                <th>Concepto</th>
                <th>Proveedor</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3" style="text-align: center; color: var(--color-texto-secundario); font-style: italic;">
                  No hay datos disponibles
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts con lógica completa de semanas -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Variables globales
      let weekIsoDates = []; // Array de fechas ISO de la semana seleccionada
      let csvData = []; // Datos del CSV cargado
      let selectedCurrency = ''; // Moneda seleccionada
      let selectedCsvUrl = ''; // URL del CSV seleccionado

      // == Funciones auxiliares para fechas ==
      
      function isDateValue(value) {
        return value instanceof Date && !isNaN(value);
      }
      
      function excelDateToJSDate(serial) {
        const utc_days = Math.floor(serial - 25569);
        const utc_value = utc_days * 86400;
        const date_info = new Date(utc_value * 1000);
        
        return new Date(Date.UTC(date_info.getUTCFullYear(), date_info.getUTCMonth(), date_info.getUTCDate()));
      }
      
      function convertToDate(value) {
        if (value instanceof Date && !isNaN(value)) return value;
        
        if (typeof value === 'number') {
          const excelDate = excelDateToJSDate(value);
          if (!isNaN(excelDate.getTime())) return excelDate;
        }
        
        if (typeof value === 'string') {
          let date = null;
          const trimmedValue = value.trim();

          if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(trimmedValue)) {
            const parts = trimmedValue.split('/');
            date = new Date(Date.UTC(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0])));
          } else if (/^\d{4}-\d{2}-\d{2}$/.test(trimmedValue)) {
            const parts = trimmedValue.split('-');
            date = new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
          } else if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(trimmedValue)) {
            const parts = trimmedValue.split('-');
            date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
          }
          
          if (date && !isNaN(date.getTime())) return date;
        }
        
        return null;
      }
      
      function formatDateISO(date) {
        if (!(date instanceof Date) || isNaN(date)) return '';
        const year = date.getUTCFullYear();
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const day = String(date.getUTCDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      function formatDate(date) {
        if (!(date instanceof Date) || isNaN(date)) return '--/--/----';
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();
        return `${day}/${month}/${year}`;
      }

      function formatDateShort(date) {
        if (!(date instanceof Date) || isNaN(date)) return '--/--';
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        return `${day}/${month}`;
      }

      // Obtiene el Lunes de la semana de la fecha dada (en UTC)
      function getMonday(date) {
        const dayOfWeek = date.getUTCDay(); // 0 = Domingo, 1 = Lunes, ... 6 = Sábado
        const diff = date.getUTCDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Ajuste para Lunes
        const monday = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), diff));
        return monday;
      }
      
      // Obtiene Lunes a Domingo de la semana que contiene fromDate (en UTC)
      function getWeekDays(fromDate) {
        const weekDays = [];
        const startOfWeek = getMonday(fromDate);
        for (let i = 0; i < 7; i++) {
          const day = new Date(Date.UTC(startOfWeek.getUTCFullYear(), startOfWeek.getUTCMonth(), startOfWeek.getUTCDate() + i));
          weekDays.push(day);
        }
        return weekDays;
      }

      // Toggle Accordion
      function toggleAccordion() {
        const content = document.getElementById('config-content');
        const header = document.getElementById('accordion-toggle');
        const icon = document.getElementById('accordion-icon');
        
        content.classList.toggle('active');
        header.classList.toggle('active');
      }

      // Populate Months
      function populateMonths() {
        const yearSelector = document.getElementById('year-selector');
        const monthSelector = document.getElementById('month-selector');
        const weekSelector = document.getElementById('week-selector');
        
        monthSelector.innerHTML = '<option value="">Mes</option>';
        weekSelector.innerHTML = '<option value="">Semana</option>';
        updateWeekTitle();
        if (!yearSelector.value) return;
        
        const months = [
          { value: '01', name: 'Enero' }, { value: '02', name: 'Febrero' },
          { value: '03', name: 'Marzo' }, { value: '04', name: 'Abril' },
          { value: '05', name: 'Mayo' }, { value: '06', name: 'Junio' },
          { value: '07', name: 'Julio' }, { value: '08', name: 'Agosto' },
          { value: '09', name: 'Septiembre' }, { value: '10', name: 'Octubre' },
          { value: '11', name: 'Noviembre' }, { value: '12', name: 'Diciembre' }
        ];
        
        months.forEach(month => {
          const option = document.createElement('option');
          option.value = month.value;
          option.textContent = month.name;
          monthSelector.appendChild(option);
        });
      }
      
      // Populate Weeks of Month
      function populateWeeksOfMonth() {
        const yearSelector = document.getElementById('year-selector');
        const monthSelector = document.getElementById('month-selector');
        const weekSelector = document.getElementById('week-selector');
        
        weekSelector.innerHTML = '<option value="">Semana</option>';
        updateWeekTitle();
        if (!yearSelector.value || !monthSelector.value) return;
        
        const year = parseInt(yearSelector.value);
        const month = parseInt(monthSelector.value); // Mes es 1-12
        
        const weeks = [];
        let currentDate = new Date(Date.UTC(year, month - 1, 1)); // Empezar en UTC
        
        while (currentDate.getUTCMonth() === month - 1) {
            const weekDays = getWeekDays(currentDate); // Obtiene semana Lunes-Domingo UTC
            const firstWeekDay = weekDays[0];
            const lastWeekDay = weekDays[6];

            // Asegurarse que la semana contenga días del mes seleccionado
            const daysInMonth = weekDays.filter(date => date.getUTCMonth() === month - 1).length;

            if (daysInMonth > 0) {
                const weekOption = {
                  value: formatDateISO(firstWeekDay), // Valor es el ISO del Lunes
                  text: `${formatDateShort(firstWeekDay)} al ${formatDateShort(lastWeekDay)}`,
                  dates: weekDays.map(d => formatDateISO(d)) // Guardar ISOs de todos los días
                };

                // Evitar duplicados si una semana ya fue añadida
                if (!weeks.some(w => w.value === weekOption.value)) {
                    weeks.push(weekOption);
                }
            }

            // Avanzar al siguiente Lunes para evitar recalcular la misma semana
            currentDate = new Date(Date.UTC(lastWeekDay.getUTCFullYear(), lastWeekDay.getUTCMonth(), lastWeekDay.getUTCDate() + 1));
            currentDate = getMonday(currentDate); // Asegurar que es Lunes
        }
        
        weeks.forEach(week => {
          const option = document.createElement('option');
          option.value = week.value;
          option.textContent = week.text;
          option.dataset.dates = JSON.stringify(week.dates); // Guardar array de ISOs
          weekSelector.appendChild(option);
        });
      }
      
      // Update Week Title
      function updateWeekTitle() {
        const weekSelector = document.getElementById('week-selector');
        const fechaReporteSpan = document.getElementById('fecha-reporte');
        
        let titleText = "-- Seleccionar periodo --";
        weekIsoDates = []; // Limpiar fechas de la semana anterior
        
        if (weekSelector.value) {
          const selectedOption = weekSelector.options[weekSelector.selectedIndex];
          titleText = "del " + selectedOption.textContent;
          if (selectedOption.dataset.dates) {
            try {
               weekIsoDates = JSON.parse(selectedOption.dataset.dates); // Guardar las fechas ISO
            } catch (e) {
               console.error("Error parseando fechas ISO de la semana:", e);
               weekIsoDates = [];
            }
          }
        }
        
        fechaReporteSpan.textContent = titleText;
        // Actualizar las tablas con las nuevas fechas
        updateTableDates(weekIsoDates);
      }

      // Update Table Dates - Actualizar fechas en las tablas
      function updateTableDates(isoDatesArray) {
        const tbodyResumen = document.getElementById('tabla-resumen')?.querySelector('tbody');
        
        if (!tbodyResumen) {
          console.error("updateTableDates: No se encontró tbody de tabla-resumen");
          return;
        }

        const rowsResumen = tbodyResumen.querySelectorAll('tr[data-date]');
        const maxDataRows = 7; 
        const diasSemana = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];

        // 1. Limpiar y preparar tabla de Resumen
        rowsResumen.forEach((row, index) => {
          if (index < 7) { // Solo las primeras 7 filas (días de la semana)
            row.dataset.date = `placeholder-${index + 1}`; 
            const cell = row.querySelector('.column-fecha');
            if (cell) cell.textContent = diasSemana[index]; // Restaurar nombre del día
            row.querySelectorAll('td').forEach(td => td.textContent = '--'); // Placeholder para celdas de datos
          }
        });

        // 2. Poblar tabla con las fechas de la semana seleccionada
        for (let index = 0; index < Math.min(maxDataRows, isoDatesArray.length); index++) {
           let isoDate = null;
           let formattedDate = '--/--/----';
           let date = null;
           let dayName = diasSemana[index];

           if (index < isoDatesArray.length) {
                   const potentialIsoDate = isoDatesArray[index];
                   if (/^\d{4}-\d{2}-\d{2}$/.test(potentialIsoDate)) {
                       isoDate = potentialIsoDate;
                       const parts = isoDate.split('-');
                       date = new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
                       if (!isNaN(date.getTime())) {
                           formattedDate = formatDate(date);
                           // Actualizar el nombre del día con la fecha
                           dayName = `${diasSemana[index]} ${formatDateShort(date)}`;
                       } else {
                           isoDate = null; date = null;
                       }
                   }
               }

               // 2a. Actualizar tabla de Resumen
               if (index < rowsResumen.length && index < 7) { // Solo días de la semana, no TOTAL
                 const rowResumen = rowsResumen[index];
                 rowResumen.dataset.date = isoDate ? isoDate : `placeholder-${index + 1}`;
                 const cellResumen = rowResumen.querySelector('th.column-fecha');
                 if (cellResumen) cellResumen.textContent = dayName;
               }

               // 2b. Actualizar detalle de egresos por día
               updateDetalleDay(diasSemana[index].toLowerCase(), dayName);
        }
      }

      // Actualizar el detalle de un día específico
      function updateDetalleDay(dayKey, dayDisplayName) {
        const detalleDay = document.getElementById(`detalle-${dayKey}`);
        if (detalleDay) {
          const header = detalleDay.querySelector('.detalle-dia-header h4');
          if (header) {
            header.innerHTML = `<i class="fas fa-calendar-day"></i> ${dayDisplayName}`;
          }
        }
      }

      // Event Listeners
      const accordionToggle = document.getElementById('accordion-toggle');
      const yearSelector = document.getElementById('year-selector');
      const monthSelector = document.getElementById('month-selector');
      const weekSelector = document.getElementById('week-selector');
      const btnCargarDatos = document.getElementById('btn-cargar-datos');
      const btnGenerarPdf = document.getElementById('btn-generar-pdf');
      
      if (accordionToggle) {
        accordionToggle.addEventListener('click', toggleAccordion);
      }
      
      if (yearSelector) {
        yearSelector.addEventListener('change', function() {
          populateMonths();
          // Marcar paso 1 como completado si hay año, mes y semana seleccionados
          checkStep1Completion();
        });
      }
      
      if (monthSelector) {
        monthSelector.addEventListener('change', function() {
          populateWeeksOfMonth();
          checkStep1Completion();
        });
      }
      
      if (weekSelector) {
        weekSelector.addEventListener('change', function() {
          updateWeekTitle();
          checkStep1Completion();
        });
      }

      if (btnCargarDatos) {
        btnCargarDatos.addEventListener('click', loadCSVData);
      }

      if (btnGenerarPdf) {
        btnGenerarPdf.addEventListener('click', generatePDF);
      }

      function checkStep1Completion() {
        const year = document.getElementById('year-selector').value;
        const month = document.getElementById('month-selector').value;
        const week = document.getElementById('week-selector').value;
        
        if (year && month && week) {
          updateStepState(1, 'completed');
          updateStepState(2, 'active');
        } else {
          updateStepState(1, 'active');
          updateStepState(2, 'future');
          updateStepState(3, 'future');
        }
      }

      // Inicialización
      enableCurrencyStep();
      updateWeekTitle(); // Llamada inicial para configurar fechas y tablas vacías
      console.log("Interfaz de Reporte de Compras inicializada con lógica completa de semanas.");

      // == Funciones para manejo de pasos ==
      
      function updateStepState(stepNumber, state) {
        const step = document.querySelector(`.config-step:nth-child(${stepNumber})`);
        if (!step) return;
        
        // Limpiar estados anteriores
        step.classList.remove('active', 'completed', 'future');
        
        // Aplicar nuevo estado
        step.classList.add(state);
        
        // Actualizar ícono según el estado
        const stepNumber_elem = step.querySelector('.step-number');
        if (state === 'completed' && stepNumber_elem) {
          stepNumber_elem.innerHTML = '<i class="fas fa-check"></i>';
        } else if (stepNumber_elem) {
          stepNumber_elem.textContent = String(stepNumber).padStart(2, '0');
        }
      }

      function enableCurrencyStep() {
        const currencySelector = document.getElementById('currency-selector');
        const btnCargarDatos = document.getElementById('btn-cargar-datos');
        
        if (currencySelector && btnCargarDatos) {
          currencySelector.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            selectedCurrency = this.value;
            selectedCsvUrl = selectedOption.dataset.url || '';
            
            // Habilitar botón de cargar datos si hay moneda seleccionada
            if (selectedCurrency && selectedCsvUrl) {
              btnCargarDatos.disabled = false;
              updateStepState(2, 'active');
            } else {
              btnCargarDatos.disabled = true;
            }
          });
        }
      }

      // == Funciones para carga de CSV ==
      
      function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        
        result.push(current.trim());
        return result;
      }
      
      function parseDateFromCSV(dateStr) {
        if (!dateStr || dateStr.trim() === '') return null;
        
        // Manejar formato DD/MM/YYYY
        const dateParts = dateStr.trim().split('/');
        if (dateParts.length === 3) {
          const day = parseInt(dateParts[0]);
          const month = parseInt(dateParts[1]) - 1; // Mes es 0-indexado en JS
          const year = parseInt(dateParts[2]);
          
          if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
            return new Date(Date.UTC(year, month, day));
          }
        }
        
        return null;
      }
      
      function populateTablesWithCSVData() {
        if (!csvData || csvData.length === 0) {
          console.log('No hay datos CSV para procesar');
          return;
        }
        
        console.log('Poblando tablas con datos CSV...');
        console.log('Fechas de la semana seleccionada:', weekIsoDates);
        
        // Preparar estructura para acumular datos por día
        const dayData = {};
        const diasSemana = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
        
        // Inicializar estructura de datos por día
        weekIsoDates.forEach((isoDate, index) => {
          if (index < 7) {
            dayData[isoDate] = {
              dayKey: diasSemana[index],
              ingresos: 0,
              egresos: 0,
              compraMoneda: 0, // Nueva propiedad para compra de moneda
              detalleEgresos: []
            };
          }
        });
        
        // Procesar datos del CSV
        csvData.forEach((row, rowIndex) => {
          if (rowIndex === 0 || !row || row.length < 4) return; // Saltar header y filas inválidas
          
          const fechaStr = row[0]; // Primera columna: Fecha
          const concepto = row[1] || ''; // Segunda columna: Concepto
          const proveedor = row[2] || ''; // Tercera columna: Proveedor
          const montoStr = row[3] || '0'; // Cuarta columna: Monto
          
          const fecha = parseDateFromCSV(fechaStr);
          if (!fecha) return;
          
          const fechaISO = formatDateISO(fecha);
          
          // Verificar si esta fecha está en la semana seleccionada
          if (weekIsoDates.includes(fechaISO)) {
            const monto = parseFloat(montoStr.replace(/[^-0-9.]/g, '')) || 0;
            
            if (dayData[fechaISO]) {
              // Verificar si es compra de moneda (concepto empieza con COMU y monto positivo)
              if (concepto.toUpperCase().startsWith('COMU') && monto > 0) {
                dayData[fechaISO].compraMoneda += monto;
              } else if (monto > 0) {
                dayData[fechaISO].ingresos += monto;
              } else if (monto < 0) {
                dayData[fechaISO].egresos += Math.abs(monto);
                dayData[fechaISO].detalleEgresos.push({
                  concepto: concepto,
                  proveedor: proveedor,
                  monto: monto
                });
              }
            }
          }
        });
        
        console.log('Datos procesados por día:', dayData);
        
        // Poblar tabla principal
        updateMainTable(dayData);
        
        // Poblar tablas de detalle
        updateDetailTables(dayData);
      }
      
      function formatNumber(num) {
        if (num === 0 || isNaN(num)) return '--';
        return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }
      
      function updateMainTable(dayData) {
        const tbody = document.getElementById('tabla-resumen')?.querySelector('tbody');
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr[data-date]');
        let totalCompraMoneda = 0;
        let totalIngresos = 0;
        let totalEgresos = 0;
        
        rows.forEach((row, index) => {
          if (index >= 7) return; // Solo procesar los primeros 7 días
          
          const isoDate = weekIsoDates[index];
          const dayInfo = dayData[isoDate];
          
          if (dayInfo) {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 4) {
              // Compra soles/dólares
              cells[0].textContent = formatNumber(dayInfo.compraMoneda);
              
              // Ingresos
              cells[1].textContent = formatNumber(dayInfo.ingresos);
              
              // Egresos
              cells[2].textContent = formatNumber(dayInfo.egresos);
              
              // Saldo (ingresos + compra - egresos)
              const saldo = dayInfo.ingresos + dayInfo.compraMoneda - dayInfo.egresos;
              cells[3].textContent = formatNumber(saldo);
              
              totalCompraMoneda += dayInfo.compraMoneda;
              totalIngresos += dayInfo.ingresos;
              totalEgresos += dayInfo.egresos;
            }
          }
        });
        
        // Actualizar fila de totales
        const totalRow = tbody.querySelector('.fila-total');
        if (totalRow) {
          const totalCells = totalRow.querySelectorAll('td');
          if (totalCells.length >= 4) {
            totalCells[0].textContent = formatNumber(totalCompraMoneda); // Total compra soles/dólares
            totalCells[1].textContent = formatNumber(totalIngresos); // Total ingresos
            totalCells[2].textContent = formatNumber(totalEgresos); // Total egresos
            const saldoTotal = totalIngresos + totalCompraMoneda - totalEgresos;
            totalCells[3].textContent = formatNumber(saldoTotal); // Saldo total
          }
        }
      }
      
      function updateDetailTables(dayData) {
        const diasSemana = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
        
        diasSemana.forEach((dayKey, index) => {
          const isoDate = weekIsoDates[index];
          const dayInfo = dayData[isoDate];
          const detalleDiv = document.getElementById(`detalle-${dayKey}`);
          
          if (detalleDiv && dayInfo) {
            const tbody = detalleDiv.querySelector('tbody');
            if (tbody) {
              // Limpiar contenido anterior
              tbody.innerHTML = '';
              
              if (dayInfo.detalleEgresos.length > 0) {
                // Consolidar comisiones bancarias
                const comisionesBancarias = [];
                const otrosEgresos = [];
                let totalComisiones = 0;
                
                dayInfo.detalleEgresos.forEach(egreso => {
                  if (egreso.concepto.toUpperCase().includes('COMISION BANCARIA')) {
                    comisionesBancarias.push(egreso);
                    totalComisiones += Math.abs(egreso.monto);
                  } else {
                    otrosEgresos.push(egreso);
                  }
                });
                
                // Agregar otros egresos primero
                otrosEgresos.forEach(egreso => {
                  const row = tbody.insertRow();
                  row.insertCell(0).textContent = egreso.concepto;
                  row.insertCell(1).textContent = egreso.proveedor;
                  const montoCell = row.insertCell(2);
                  montoCell.textContent = '-' + formatNumber(Math.abs(egreso.monto));
                  montoCell.style.textAlign = 'right';
                });
                
                // Agregar comisiones bancarias consolidadas si existen
                if (comisionesBancarias.length > 0) {
                  const row = tbody.insertRow();
                  row.insertCell(0).textContent = 'COMISION BANCARIA';
                  row.insertCell(1).textContent = 'VARIOS';
                  const montoCell = row.insertCell(2);
                  montoCell.textContent = '-' + formatNumber(totalComisiones);
                  montoCell.style.textAlign = 'right';
                }
              } else {
                // Mostrar mensaje de no hay datos
                const row = tbody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 3;
                cell.style.textAlign = 'center';
                cell.style.color = 'var(--color-texto-secundario)';
                cell.style.fontStyle = 'italic';
                cell.textContent = 'No hay egresos para este día';
              }
            }
          }
        });
      }
      
      async function loadCSVData() {
        if (!selectedCsvUrl) {
          alert('Por favor seleccione una moneda primero');
          return;
        }

        const btnCargarDatos = document.getElementById('btn-cargar-datos');
        if (btnCargarDatos) {
          btnCargarDatos.disabled = true;
          btnCargarDatos.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
        }

        try {
          console.log('Cargando CSV desde:', selectedCsvUrl);
          
          const response = await fetch(selectedCsvUrl);
          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
          }
          
          const csvText = await response.text();
          console.log('CSV cargado exitosamente');
          
          // Parsear CSV correctamente
          const lines = csvText.split('\n').filter(line => line.trim() !== '');
          csvData = lines.map(line => parseCSVLine(line));
          
          console.log('Datos CSV parseados:', csvData.length, 'filas');
          console.log('Primeras 5 filas:', csvData.slice(0, 5));
          
          // Poblar las tablas con los datos del CSV
          populateTablesWithCSVData();
          
          // Marcar paso 2 como completado
          updateStepState(2, 'completed');
          
          // Habilitar paso 3
          updateStepState(3, 'active');
          const btnGenerarPdf = document.getElementById('btn-generar-pdf');
          if (btnGenerarPdf) {
            btnGenerarPdf.disabled = false;
          }
          
        } catch (error) {
          console.error('Error al cargar CSV:', error);
          alert('Error al cargar los datos: ' + error.message);
        } finally {
          if (btnCargarDatos) {
            btnCargarDatos.disabled = false;
            btnCargarDatos.innerHTML = '<i class="fas fa-download"></i> Cargar datos';
          }
        }
      }

      function generatePDF() {
        console.log('TODO: Generar PDF');
        alert('Funcionalidad de PDF pendiente de implementar');
        
        // Marcar paso 3 como completado
        updateStepState(3, 'completed');
      }
    });
  </script>
</body>
</html>
