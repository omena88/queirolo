<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asistente de Reportes - Santiago Queirolo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Preline UI CSS -->
  <script src="https://cdn.jsdelivr.net/npm/preline/dist/preline.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --red-pantone: #e63946ff;
      --honeydew: #f1faeeff;
      --non-photo-blue: #a8dadcff;
      --cerulean: #457b9dff;
      --berkeley-blue: #1d3557ff;
      --primary-color: var(--cerulean);
      --secondary-color: var(--non-photo-blue);
      --background-color: var(--honeydew);
      --text-dark: var(--berkeley-blue);
      --text-light: #6b7280;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--background-color);
      min-height: 100vh;
    }

    /* Main Container */
    .main-container {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .app-container {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* File Upload Styles */
    .file-upload-area {
      display: block;
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      background: #f9fafb;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 16px;
    }

    .file-upload-area:hover {
      border-color: var(--primary-color);
      background: var(--honeydew);
    }

    .file-upload-area.dragover {
      border-color: var(--primary-color);
      background: var(--non-photo-blue);
      transform: scale(1.02);
    }

    .upload-icon {
      width: 32px;
      height: 32px;
      margin: 0 auto 12px;
      color: #9ca3af;
    }

    .upload-text {
      font-size: 14px;
      color: #374151;
      margin-bottom: 4px;
    }

    .upload-hint {
      font-size: 12px;
      color: #9ca3af;
    }

    .file-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .file-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #edf2f7;
      color: #1f2937;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    /* Processing & Results */
    .processing-area {
      text-align: center;
      padding: 20px;
      background: #fff7ed;
      border: 1px solid #f97316;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .processing-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #f97316;
      border-top: 2px solid #ea580c;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .hidden {
      display: none;
    }

    /* Modal Styles */
    #report-modal h3 {
      font-size: 16px !important;
      line-height: 1.1 !important;
    }

    #rep-tabla-ventas thead,
    #rep-tabla-ventas tbody {
      font-size: 9px !important;
    }

    #rep-tabla-resumen,
    #rep-tabla-venta-tipo,
    #rep-tabla-venta-cliente,
    #rep-tabla-produccion {
      font-size: 10px !important;
    }
  </style>
</head>

<body>

  <div class="main-container">
    <div class="app-container">

      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <h1
          style="font-size: 1.5rem !important; font-weight: 700 !important; color: #111827 !important; display: flex !important; align-items: center !important; gap: 0.75rem !important; margin: 0 !important;">
          <i class="fas fa-chart-line" style="color: #3b82f6 !important;"></i>
          Reporte Semanal de Ventas
        </h1>
      </div>

      <!-- Configuration Card -->
      <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
        <div class="flex items-center gap-3 mb-4">
          <span
            style="display: flex !important; align-items: center !important; justify-content: center !important; width: 2rem !important; height: 2rem !important; background-color: #dbeafe !important; color: #3b82f6 !important; border-radius: 9999px !important; font-weight: 700 !important; font-size: 0.875rem !important;">01</span>
          <h2
            style="font-size: 1.125rem !important; font-weight: 700 !important; color: #111827 !important; margin: 0 !important;">
            ConfiguraciÃ³n del Periodo</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">AÃ±o</label>
            <select id="year-selector"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
              <option value="">Seleccionar aÃ±o</option>
              <option value="2024">2024</option>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
            </select>
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Mes</label>
            <select id="month-selector"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 disabled:bg-gray-200 disabled:cursor-not-allowed"
              disabled>
              <option value="">Seleccionar mes</option>
            </select>
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Semana</label>
            <select id="week-selector"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 disabled:bg-gray-200 disabled:cursor-not-allowed"
              disabled>
              <option value="">Seleccionar semana</option>
            </select>
          </div>
        </div>

        <!-- Exchange Rate Validation Section (Hidden by default) -->
        <div id="exchange-rate-section" class="mt-6 pt-6 border-t border-gray-200 hidden">
          <h4 class="text-sm font-semibold text-gray-900 mb-3">Validar Tipos de Cambio</h4>
          <div id="exchange-rate-grid" class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div id="exchange-rate-list" class="contents">
              <!-- Exchange rates injected here (7 items) -->
            </div>
            <div class="flex items-end">
              <button id="confirm-config-btn"
                class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 transition-all">
                Actualizar TC
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Upload Card -->
      <div id="upload-card"
        class="bg-white rounded-lg shadow-md border border-gray-200 p-6 opacity-50 pointer-events-none transition-opacity duration-300">
        <div class="flex items-center gap-3 mb-4">
          <span
            style="display: flex !important; align-items: center !important; justify-content: center !important; width: 2rem !important; height: 2rem !important; background-color: #dbeafe !important; color: #3b82f6 !important; border-radius: 9999px !important; font-weight: 700 !important; font-size: 0.875rem !important;">02</span>
          <h2
            style="font-size: 1.125rem !important; font-weight: 700 !important; color: #111827 !important; margin: 0 !important;">
            Cargar Documentos</h2>
        </div>

        <div class="file-upload-area" id="mass-upload-area">
          <i class="fas fa-cloud-upload-alt upload-icon"></i>
          <div class="upload-text">Arrastra y suelta tus archivos Excel aquÃ­</div>
          <div class="upload-hint">o haz clic para seleccionar (Ventas, Propinas, etc.)</div>
          <input type="file" id="mass-file-input" multiple accept=".xlsx,.xls" class="hidden">
        </div>

        <div id="file-mapping-container" class="hidden">
          <div id="mapped-files" class="file-list mb-4"></div>
        </div>

        <div class="flex justify-end">
          <button id="process-btn"
            class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 disabled:opacity-50 disabled:cursor-not-allowed transition-all inline-flex items-center gap-2"
            disabled>
            <i class="fas fa-cogs"></i>
            Procesar Reporte
          </button>
        </div>
      </div>

      <!-- Results Card -->
      <div id="results-card" class="bg-white rounded-lg shadow-md border border-gray-200 p-6 hidden">
        <div class="flex items-center gap-3 mb-4">
          <span
            style="display: flex !important; align-items: center !important; justify-content: center !important; width: 2rem !important; height: 2rem !important; background-color: #d1fae5 !important; color: #10b981 !important; border-radius: 9999px !important; font-weight: 700 !important; font-size: 0.875rem !important;">03</span>
          <h2
            style="font-size: 1.125rem !important; font-weight: 700 !important; color: #111827 !important; margin: 0 !important;">
            Resultados</h2>
        </div>

        <div id="processing-view" class="processing-area hidden">
          <div class="processing-spinner"></div>
          <p id="progress-text" class="text-sm text-gray-700 font-medium">Iniciando...</p>
          <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3 max-w-md mx-auto">
            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%">
            </div>
          </div>
        </div>

        <div id="success-view" class="hidden text-center py-6">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-check text-green-600 text-2xl"></i>
          </div>
          <h3 class="text-xl font-semibold text-gray-900 mb-2">Â¡Reporte Generado!</h3>
          <p class="text-gray-600 mb-6">El reporte semanal de ventas estÃ¡ listo para descargar.</p>

          <div class="flex justify-center gap-4">
            <button id="view-report"
              class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-5 py-2.5 inline-flex items-center gap-2">
              <i class="fas fa-eye"></i>
              Ver Reporte
            </button>
            <button id="download-pdf"
              class="text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 inline-flex items-center gap-2">
              <i class="fas fa-file-pdf"></i>
              Descargar PDF
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Modal for Report View -->
  <div id="report-modal" class="fixed inset-0 z-[1000] hidden" style="background: rgba(0,0,0,0.55);">
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div
        class="bg-white rounded-2xl shadow-2xl w-full max-w-[1400px] h-[90vh] relative overflow-hidden flex flex-col">
        <div class="flex justify-between items-center p-4 border-b">
          <h3 class="font-bold text-lg">Vista Previa del Reporte</h3>
          <button id="close-report-modal" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div id="report-content" class="w-full h-full overflow-auto p-4 bg-gray-50"></div>
      </div>
    </div>
  </div>

  <script>
    // VerificaciÃ³n de librerÃ­as disponibles
    function checkLibraries() {
      const issues = [];
      if (typeof XLSX === 'undefined') issues.push('XLSX no estÃ¡ disponible');
      if (typeof window.jspdf === 'undefined') issues.push('jsPDF no estÃ¡ disponible');
      if (issues.length > 0) {
        console.warn('LibrerÃ­as faltantes:', issues);
        return false;
      }
      return true;
    }

    // Endpoint del snippet de WordPress para tipo de cambio
    const EXCHANGE_RATE_ENDPOINT = './1.1 tipo de cambio.php';
    let currentStep = 1;
    let selectedPeriod = {};
    let uploadedFiles = {};
    let weekIsoDates = [];

    // ConfiguraciÃ³n de meses
    const months = [
      { value: '01', name: 'Enero' }, { value: '02', name: 'Febrero' }, { value: '03', name: 'Marzo' },
      { value: '04', name: 'Abril' }, { value: '05', name: 'Mayo' }, { value: '06', name: 'Junio' },
      { value: '07', name: 'Julio' }, { value: '08', name: 'Agosto' }, { value: '09', name: 'Septiembre' },
      { value: '10', name: 'Octubre' }, { value: '11', name: 'Noviembre' }, { value: '12', name: 'Diciembre' }
    ];

    // Funciones de formateo de fechas
    function formatDate(date, format = 'DD/MM/YYYY', options = {}) {
      if (!(date instanceof Date) || isNaN(date)) return options.fallback || '--/--/----';
      const formats = {
        'DD/MM/YYYY': (d) => `${d.getUTCDate().toString().padStart(2, '0')}/${(d.getUTCMonth() + 1).toString().padStart(2, '0')}/${d.getUTCFullYear()}`,
        'YYYY-MM-DD': (d) => `${d.getUTCFullYear()}-${(d.getUTCMonth() + 1).toString().padStart(2, '0')}-${d.getUTCDate().toString().padStart(2, '0')}`,
        'DD/MM': (d) => `${d.getUTCDate().toString().padStart(2, '0')}/${(d.getUTCMonth() + 1).toString().padStart(2, '0')}`
      };
      return formats[format] ? formats[format](date) : formats['DD/MM/YYYY'](date);
    }

    const formatDateISO = (date) => formatDate(date, 'DD/MM/YYYY');
    const formatDateISOForData = (date) => formatDate(date, 'YYYY-MM-DD');
    const formatDateShort = (date) => formatDate(date, 'DD/MM');

    function getMonday(date) {
      const dayOfWeek = date.getUTCDay();
      const diff = date.getUTCDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
      return new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), diff));
    }

    function getWeekDays(fromDate) {
      const weekDays = [];
      const startOfWeek = getMonday(fromDate);
      for (let i = 0; i < 7; i++) {
        weekDays.push(new Date(Date.UTC(startOfWeek.getUTCFullYear(), startOfWeek.getUTCMonth(), startOfWeek.getUTCDate() + i)));
      }
      return weekDays;
    }

    function populateWeeksOfMonth() {
      const yearSelector = document.getElementById('year-selector');
      const monthSelector = document.getElementById('month-selector');
      const weekSelector = document.getElementById('week-selector');

      weekSelector.innerHTML = '<option value="">Seleccionar semana</option>';
      if (!yearSelector.value || !monthSelector.value) return;

      const year = parseInt(yearSelector.value);
      const month = parseInt(monthSelector.value);
      const weeks = [];
      const firstOfMonth = new Date(Date.UTC(year, month - 1, 1));
      let cursor = getMonday(firstOfMonth);

      while (cursor.getUTCMonth() <= (month - 1)) {
        const weekDays = getWeekDays(cursor);
        const firstWeekDay = weekDays[0];
        const lastWeekDay = weekDays[6];
        if (firstWeekDay.getUTCMonth() > (month - 1)) break;

        const option = {
          value: formatDateISO(firstWeekDay),
          text: `${formatDateShort(firstWeekDay)} al ${formatDateShort(lastWeekDay)}`,
          dates: weekDays.map(d => formatDateISOForData(d))
        };
        if (!weeks.some(w => w.value === option.value)) weeks.push(option);
        cursor = new Date(Date.UTC(firstWeekDay.getUTCFullYear(), firstWeekDay.getUTCMonth(), firstWeekDay.getUTCDate() + 7));
      }

      weeks.forEach(week => {
        const option = document.createElement('option');
        option.value = week.value;
        option.textContent = week.text;
        option.dataset.dates = JSON.stringify(week.dates);
        weekSelector.appendChild(option);
      });
    }

    // InicializaciÃ³n
    document.addEventListener('DOMContentLoaded', function () {
      console.log('ðŸš€ AplicaciÃ³n iniciada');
      if (!checkLibraries()) console.error('âŒ Algunas librerÃ­as no estÃ¡n disponibles.');
      setupEventListeners();
    });

    function setupEventListeners() {
      // Selectores
      const yearSelector = document.getElementById('year-selector');
      const monthSelector = document.getElementById('month-selector');
      const weekSelector = document.getElementById('week-selector');

      if (yearSelector) {
        yearSelector.addEventListener('change', (e) => {
          updateMonthSelector();
        });
      }

      if (monthSelector) {
        monthSelector.addEventListener('change', (e) => {
          updateWeekSelector();
        });
      }

      if (weekSelector) {
        weekSelector.addEventListener('change', (e) => {
          validateStep1();
        });
      }

      // Botones de acciÃ³n
      const confirmConfigBtn = document.getElementById('confirm-config-btn');
      if (confirmConfigBtn) {
        confirmConfigBtn.addEventListener('click', confirmConfiguration);
      }

      const processBtn = document.getElementById('process-btn');
      if (processBtn) {
        processBtn.addEventListener('click', startProcessing);
      }

      // Carga masiva
      setupMassUpload();

      // Descarga y visualizaciÃ³n
      const downloadPdfBtn = document.getElementById('download-pdf');
      if (downloadPdfBtn) {
        downloadPdfBtn.addEventListener('click', () => {
          try {
            generatePDF();
          } catch (error) {
            console.error('âŒ Error generando PDF:', error);
            alert('Error generando PDF. Ver consola.');
          }
        });
      }

      const viewBtn = document.getElementById('view-report');
      if (viewBtn) viewBtn.addEventListener('click', openReportModal);

      const closeModalBtn = document.getElementById('close-report-modal');
      if (closeModalBtn) closeModalBtn.addEventListener('click', closeReportModal);
    }

    function setupMassUpload() {
      const massUploadArea = document.getElementById('mass-upload-area');
      const massFileInput = document.getElementById('mass-file-input');

      massUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        massUploadArea.classList.add('dragover');
      });

      massUploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        massUploadArea.classList.remove('dragover');
      });

      massUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        massUploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        processMassFiles(files);
      });

      massUploadArea.addEventListener('click', () => massFileInput.click());

      massFileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        processMassFiles(files);
      });
    }

    function processMassFiles(files) {
      const mappedFiles = document.getElementById('mapped-files');
      const container = document.getElementById('file-mapping-container');
      const uploadArea = document.getElementById('mass-upload-area');

      // Limpiar visualmente
      mappedFiles.innerHTML = '';
      container.classList.remove('hidden');

      const mappings = {
        'ventas': ['venta', 'sale', 'ventas'],
        'propinas': ['propina', 'tip', 'propinas'],
        'prod-cimp': ['cimp', 'con_imp', 'con impuesto', 'conimp'],
        'prod-simp': ['simp', 'sin_imp', 'sin impuesto', 'sinimp'],
        'clientes': ['cliente', 'client', 'clientes', 'customer']
      };

      const typeNames = {
        'ventas': 'Ventas', 'propinas': 'Propinas', 'prod-cimp': 'Prod. c/imp',
        'prod-simp': 'Prod. s/imp', 'clientes': 'Clientes'
      };

      uploadedFiles = {};

      files.forEach(file => {
        const fileName = file.name.toLowerCase();
        let mappedTo = null;
        let bestMatch = 0;

        for (const [type, keywords] of Object.entries(mappings)) {
          for (const keyword of keywords) {
            if (fileName.includes(keyword)) {
              const matchScore = keyword.length;
              if (matchScore > bestMatch) {
                bestMatch = matchScore;
                mappedTo = type;
              }
            }
          }
        }

        if (mappedTo && !uploadedFiles[mappedTo + '-file']) {
          const fileId = `file-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          const fileDiv = document.createElement('div');
          fileDiv.className = 'file-badge';
          fileDiv.id = fileId;
          fileDiv.innerHTML = `
            <i class="fas fa-file-excel text-green-600"></i>
            <span class="font-medium">${file.name}</span>
            <span class="text-xs text-gray-500">(${typeNames[mappedTo]})</span>
            <button class="remove ml-2 text-red-500 hover:text-red-700" onclick="removeDocument('${fileId}', '${mappedTo}')">
              <i class="fas fa-times"></i>
            </button>
          `;
          mappedFiles.appendChild(fileDiv);

          uploadedFiles[mappedTo + '-file'] = { file: file, elementId: fileId };
        }
      });

      validateUploadStep();
    }

    function removeDocument(fileId, fileType) {
      const element = document.getElementById(fileId);
      if (element) element.remove();

      const key = fileType + '-file';
      if (uploadedFiles[key]) delete uploadedFiles[key];

      validateUploadStep();
    }

    function updateMonthSelector() {
      const year = document.getElementById('year-selector').value;
      const monthSelector = document.getElementById('month-selector');

      if (year) {
        monthSelector.disabled = false;
        monthSelector.innerHTML = '<option value="">Seleccionar mes</option>';
        months.forEach(month => {
          monthSelector.innerHTML += `<option value="${month.value}">${month.name}</option>`;
        });
        monthSelector.value = "";
      } else {
        monthSelector.disabled = true;
        monthSelector.innerHTML = '<option value="">Seleccionar mes</option>';
      }

      document.getElementById('week-selector').disabled = true;
      document.getElementById('week-selector').innerHTML = '<option value="">Seleccionar semana</option>';
    }

    function updateWeekSelector() {
      const month = document.getElementById('month-selector').value;
      const weekSelector = document.getElementById('week-selector');

      if (month) {
        weekSelector.disabled = false;
        populateWeeksOfMonth();
      } else {
        weekSelector.disabled = true;
        weekSelector.innerHTML = '<option value="">Seleccionar semana</option>';
      }
    }

    // --- LÃ³gica de ConfiguraciÃ³n y Tipos de Cambio ---

    function validateStep1() {
      const year = document.getElementById('year-selector').value;
      const month = document.getElementById('month-selector').value;
      const week = document.getElementById('week-selector').value;

      if (year && month && week) {
        const selectedOption = document.getElementById('week-selector').options[document.getElementById('week-selector').selectedIndex];
        selectedPeriod = { year, month, week, weekText: selectedOption.textContent };

        if (selectedOption.dataset.dates) {
          weekIsoDates = JSON.parse(selectedOption.dataset.dates);
          // Mostrar secciÃ³n de tipos de cambio
          document.getElementById('exchange-rate-section').classList.remove('hidden');
          fetchExchangeRates(weekIsoDates);
        }
      } else {
        document.getElementById('exchange-rate-section').classList.add('hidden');
      }
    }

    async function fetchExchangeRates(dates) {
      if (!dates || dates.length === 0) return;

      const container = document.getElementById('exchange-rate-list');
      container.innerHTML = '<div class="text-sm text-gray-500"><i class="fas fa-spinner fa-spin"></i> Cargando tipos de cambio...</div>';

      try {
        // Convertir fechas para API
        const convertedDates = dates.map(date => {
          const parts = date.split('-');
          return `${parts[2]}/${parts[1]}/${parts[0]}`;
        });

        const formData = new FormData();
        formData.append('action', 'get_exchange_rates');
        formData.append('dates', JSON.stringify(convertedDates));

        const endpoint = window.location.origin + '/wp-admin/admin-ajax.php';
        // Fallback local si no estamos en WP
        // const endpoint = EXCHANGE_RATE_ENDPOINT; 

        // SimulaciÃ³n o llamada real
        let rates = {};
        try {
          const response = await fetch(endpoint, { method: 'POST', body: formData });
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.data && data.data.rates) {
              rates = data.data.rates;
            }
          }
        } catch (e) {
          console.warn('No se pudo conectar con API de TC, usando valores por defecto');
        }

        // Renderizar inputs
        container.innerHTML = '';
        dates.forEach(dateISO => {
          const parts = dateISO.split('-');
          const dateKey = `${parts[2]}/${parts[1]}/${parts[0]}`;
          const rate = rates[dateKey] || 3.70;

          const div = document.createElement('div');
          div.className = 'flex flex-col';
          div.innerHTML = `
            <label class="block mb-1 text-xs font-medium text-gray-700">${dateKey}</label>
            <input type="number" step="0.0001" value="${rate}" data-date="${dateISO}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
          `;
          container.appendChild(div);
        });

      } catch (error) {
        console.error('Error fetching rates:', error);
        container.innerHTML = '<div class="text-sm text-red-500">Error cargando tipos de cambio. Ingrese manualmente.</div>';
      }
    }

    function confirmConfiguration() {
      // Guardar tipos de cambio
      const inputs = document.querySelectorAll('#exchange-rate-list input');
      exchangeRates = {};
      inputs.forEach(input => {
        const dateISO = input.dataset.date;
        const parts = dateISO.split('-');
        const dateKey = `${parts[2]}/${parts[1]}/${parts[0]}`;
        exchangeRates[dateKey] = parseFloat(input.value);
      });

      // Bloquear configuraciÃ³n y mostrar carga
      document.getElementById('year-selector').disabled = true;
      document.getElementById('month-selector').disabled = true;
      document.getElementById('week-selector').disabled = true;
      document.getElementById('confirm-config-btn').disabled = true;
      document.getElementById('confirm-config-btn').textContent = 'ConfiguraciÃ³n Confirmada';
      document.getElementById('confirm-config-btn').classList.add('bg-green-600', 'hover:bg-green-700');
      document.getElementById('confirm-config-btn').classList.remove('bg-blue-600', 'hover:bg-blue-700');

      const uploadCard = document.getElementById('upload-card');
      uploadCard.classList.remove('opacity-50', 'pointer-events-none');
    }

    // --- LÃ³gica de Carga y Procesamiento ---

    function validateUploadStep() {
      const required = ['ventas-file', 'propinas-file', 'prod-cimp-file', 'prod-simp-file', 'clientes-file'];
      const isValid = required.every(key => uploadedFiles[key]);
      const btn = document.getElementById('process-btn');
      if (btn) {
        btn.disabled = !isValid;
        if (isValid) {
          btn.classList.remove('opacity-50', 'pointer-events-none');
        } else {
          btn.classList.add('opacity-50', 'pointer-events-none');
        }
      }
    }

    async function startProcessing() {
      document.getElementById('upload-card').classList.add('opacity-50', 'pointer-events-none');
      document.getElementById('results-card').classList.remove('hidden');
      document.getElementById('processing-view').classList.remove('hidden');

      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');

      const steps = [
        { progress: 20, text: 'Validando archivos...' },
        { progress: 40, text: 'Procesando datos de ventas...' },
        { progress: 60, text: 'Analizando propinas y producciÃ³n...' },
        { progress: 80, text: 'Generando cÃ¡lculos...' },
        { progress: 100, text: 'Finalizando reporte...' }
      ];

      let currentStepIndex = 0;
      const interval = setInterval(async () => {
        if (currentStepIndex < steps.length) {
          const step = steps[currentStepIndex];
          progressBar.style.width = step.progress + '%';
          progressText.textContent = step.text;
          currentStepIndex++;
        } else {
          clearInterval(interval);
          try {
            await processAllUploadedFiles();
            document.getElementById('processing-view').classList.add('hidden');
            document.getElementById('success-view').classList.remove('hidden');
          } catch (error) {
            console.error(error);
            progressText.textContent = 'Error: ' + error.message;
            progressText.classList.add('text-red-600');
            document.getElementById('upload-card').classList.remove('opacity-50', 'pointer-events-none');
          }
        }
      }, 600);
    }

    // Variables globales de datos
    let exchangeRates = {};
    let extractedReportData = [];
    let propinasTotal = 0;
    let produccionConImp = 0;
    let produccionSinImp = 0;
    let ocupabilidad = 0;
    let queiroloTotal = 0;
    let tiendaVentaTotal = 0;

    async function processAllUploadedFiles() {
      const filesToProcess = [
        uploadedFiles['ventas-file'] ? processVentasXlsx(uploadedFiles['ventas-file'].file) : Promise.resolve(),
        uploadedFiles['propinas-file'] ? processPropinasXlsx(uploadedFiles['propinas-file'].file) : Promise.resolve(),
        uploadedFiles['prod-cimp-file'] ? processProduccionConImpXlsx(uploadedFiles['prod-cimp-file'].file) : Promise.resolve(),
        uploadedFiles['prod-simp-file'] ? processProduccionSinImpXlsx(uploadedFiles['prod-simp-file'].file) : Promise.resolve(),
        uploadedFiles['clientes-file'] ? processClientesXlsx(uploadedFiles['clientes-file'].file) : Promise.resolve()
      ];
      await Promise.all(filesToProcess);
      // Preparar modal (sin abrirlo aun)
      const container = document.getElementById('report-content');
      if (container) {
        container.innerHTML = buildReplicatedReportHTML();
        createReportTableRows();
        setTimeout(() => mapExtractedDataToHtmlTable(), 100);
      }
    }

    // --- Procesadores de Archivos ---

    async function processExcelFile(file, fileType) {
      try {
        const jsonData = await readXlsxAsArray(file);

        switch (fileType) {
          case 'propinas': {
            let ultimoValor = null;
            for (let i = jsonData.length - 1; i >= 0; i--) {
              if (jsonData[i] && jsonData[i].length > 5 && jsonData[i][5] !== undefined && jsonData[i][5] !== '') {
                ultimoValor = jsonData[i][5];
                break;
              }
            }
            if (ultimoValor !== null) propinasTotal = convertToNumber(ultimoValor);
            break;
          }
          case 'produccion-con-imp': {
            let valorH = null, valorG = null, contadorG = 0;
            for (let i = 0; i < jsonData.length; i++) {
              const row = jsonData[i];
              if (valorH === null && row && row.length > 7 && row[7]) valorH = row[7];
              if (contadorG < 2 && row && row.length > 6 && row[6]) {
                contadorG++;
                if (contadorG === 2) valorG = row[6];
              }
              if (valorH !== null && valorG !== null) break;
            }
            if (valorH !== null) produccionConImp = convertToNumber(String(valorH).replace(/[S/$/â‚¹Â£â‚¬Â¥]/g, '').trim());
            if (valorG !== null) {
              let val = valorG;
              if (typeof val === 'string' && val.includes('%')) val = val.replace('%', '').trim();
              else if (typeof val === 'number' && val <= 1) val = val * 100;
              ocupabilidad = convertToNumber(val);
            }
            break;
          }
          case 'produccion-sin-imp': {
            let valorH = null;
            for (let i = 0; i < jsonData.length; i++) {
              const row = jsonData[i];
              if (row && row.length > 7 && row[7]) { valorH = row[7]; break; }
            }
            if (valorH !== null) produccionSinImp = convertToNumber(String(valorH).replace(/[S/$/â‚¹Â£â‚¬Â¥]/g, '').trim());
            break;
          }
          case 'clientes': {
            let total = 0;
            for (let i = 0; i < jsonData.length; i++) {
              const row = jsonData[i];
              if (row && row.length > 0 && String(row[0]).trim().toUpperCase() === 'SANTIAGO QUEIROLO S.A.C.') {
                if (row.length > 9) total += convertToNumber(row[9]);
              }
            }
            queiroloTotal = total;
            break;
          }
        }
      } catch (error) {
        console.error(`Error procesando ${fileType}:`, error);
        throw error;
      }
    }

    const processPropinasXlsx = (file) => processExcelFile(file, 'propinas');
    const processProduccionConImpXlsx = (file) => processExcelFile(file, 'produccion-con-imp');
    const processProduccionSinImpXlsx = (file) => processExcelFile(file, 'produccion-sin-imp');
    const processClientesXlsx = (file) => processExcelFile(file, 'clientes');

    async function processVentasXlsx(file) {
      if (!file) return;
      try {
        const jsonData = await readXlsxAsArray(file);

        // LÃ³gica Tienda de Vinos
        let tiendaRowIndex = -1, totalRowIndex = -1;
        tiendaVentaTotal = 0;
        for (let i = 0; i < jsonData.length; i++) {
          if (String(jsonData[i][0]).trim().toLowerCase().includes('tienda')) { tiendaRowIndex = i; break; }
        }
        if (tiendaRowIndex !== -1) {
          for (let i = tiendaRowIndex + 1; i < jsonData.length; i++) {
            if (String(jsonData[i][1]).trim().toLowerCase().includes('total')) { totalRowIndex = i; break; }
          }
        }
        if (totalRowIndex !== -1) {
          const totalRow = jsonData[totalRowIndex];
          for (let i = totalRow.length - 1; i >= 0; i--) {
            if (totalRow[i]) {
              tiendaVentaTotal = convertToNumber(String(totalRow[i]).replace(/,/g, ''));
              break;
            }
          }
        }

        // LÃ³gica Secc.
        let seccIndex = -1;
        for (let i = 0; i < jsonData.length; i++) {
          if (jsonData[i].length > 0 && String(jsonData[i][0] || '').trim().toUpperCase().includes('SECC')) {
            seccIndex = i;
          }
        }

        if (seccIndex === -1) throw new Error("No se encontrÃ³ fila 'Secc.'");

        const extractedData = [];
        const rowLimit = Math.min(seccIndex + 8, jsonData.length - 1);
        for (let i = seccIndex; i <= rowLimit; i++) {
          const excelRow = jsonData[i] || [];
          const newRow = [];
          for (let j = 0; j < 17; j++) {
            const rawValue = (j < excelRow.length ? excelRow[j] : '');
            let processedValue = rawValue;
            if (i > seccIndex && j === 0 && rawValue) {
              processedValue = convertToDate(rawValue) || null;
            }
            newRow.push(processedValue);
          }
          extractedData.push(newRow);
        }
        extractedReportData = extractedData;

      } catch (error) {
        console.error('Error procesando ventas:', error);
        throw error;
      }
    }
    // --- LÃ³gica de Reporte y PDF ---

    function buildReplicatedReportHTML() {
      return `
        <div class="max-w-[1380px] mx-auto space-y-6">
          <div class="p-5 bg-white rounded-xl shadow-lg border border-gray-200">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-[16px] leading-none font-semibold text-gray-900 flex items-center gap-2"><i class="fas fa-table text-emerald-600"></i> Resumen de venta por dÃ­a</h3>
              <button id="download-pdf-btn" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700">
                <i class="fas fa-file-pdf mr-2"></i> Descargar PDF
              </button>
            </div>
            <div class="overflow-auto">
              <table id="rep-tabla-ventas" class="min-w-full text-[9px] text-gray-700">
                <thead class="bg-gray-50 text-gray-600 font-semibold text-[9px]">
                  <tr>
                    <th class="px-3 py-2 text-left">Fecha</th>
                    <th class="px-3 py-2">CREDITO</th>
                    <th class="px-3 py-2">DEPOSITO DOLARES</th>
                    <th class="px-3 py-2">DEPOSITO SOLES</th>
                    <th class="px-3 py-2">EFECTIVO DOLARES</th>
                    <th class="px-3 py-2">EFECTIVO SOLES</th>
                    <th class="px-3 py-2">TARJETA DOLARES AMEX-DOL</th>
                    <th class="px-3 py-2">TARJETA DOLARES DC-DOL</th>
                    <th class="px-3 py-2">TARJETA DOLARES MC-DOL</th>
                    <th class="px-3 py-2">TARJETA DOLARES VISA-DOL</th>
                    <th class="px-3 py-2">TARJETA SOLES AMEX-SOL</th>
                    <th class="px-3 py-2">TARJETA SOLES DC-SOL</th>
                    <th class="px-3 py-2">TARJETA SOLES MC-SOL</th>
                    <th class="px-3 py-2">TARJETA SOLES VISA-SOL</th>
                    <th class="px-3 py-2">TRANSFER. DOLARES</th>
                    <th class="px-3 py-2">TRANSFER. SOLES</th>
                    <th class="px-3 py-2" style="min-width: 90px;">Total</th>
                  </tr>
                </thead>
                <tbody id="rep-ventas-body" class="divide-y divide-gray-100"></tbody>
                <tfoot id="rep-ventas-foot">
                    <tr id="rep-totals-pen-row" class="bg-gray-50 font-semibold">
                        <th scope="row" class="px-3 py-2 text-left">TOTAL PEN</th>
                        ${Array(16).fill('<td class="px-3 py-2 text-right">0.00</td>').join('')}
                  </tr>
                    <tr id="rep-totals-usd-row" class="bg-gray-50 font-semibold">
                        <th scope="row" class="px-3 py-2 text-left">TOTAL USD</th>
                        ${Array(16).fill('<td class="px-3 py-2 text-right">--</td>').join('')}
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="p-5 bg-white rounded-xl shadow-lg border border-gray-200 lg:col-span-2">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-[16px] leading-none font-semibold text-gray-900 flex items-center gap-2"><i class="fas fa-chart-bar text-emerald-600"></i> Resumen de venta total</h3>
              </div>
              <div class="overflow-auto">
                <table id="rep-tabla-resumen" class="min-w-full text-gray-700">
                  <thead class="bg-gray-50 text-gray-600 font-semibold">
                    <tr>
                      <th class="px-3 py-2 text-left">Fecha</th>
                      <th class="px-3 py-2">Total PEN</th>
                      <th class="px-3 py-2">PEN</th>
                      <th class="px-3 py-2">USD en PEN</th>
                      <th class="px-3 py-2">USD</th>
                      <th class="px-3 py-2">T.C.</th>
                    </tr>
                  </thead>
                  <tbody id="rep-resumen-body" class="divide-y divide-gray-100"></tbody>
                  <tfoot>
                    <tr class="bg-gray-50 font-semibold text-gray-900">
                      <th class="px-3 py-2 text-left">TOTALES</th>
                      <td class="px-3 py-2 text-right whitespace-nowrap" id="rep-total-pen"></td>
                      <td class="px-3 py-2 text-right whitespace-nowrap" id="rep-total-only-pen"></td>
                      <td class="px-3 py-2 text-right whitespace-nowrap" id="rep-total-usd-pen"></td>
                      <td class="px-3 py-2 text-right whitespace-nowrap" id="rep-total-usd"></td>
                      <td class="px-3 py-2"></td>
                    </tr>
                    <tr class="bg-gray-50 text-gray-700">
                      <th class="px-3 py-2 text-left">%</th>
                      <td class="px-3 py-2"></td>
                      <td class="px-3 py-2" id="rep-pct-pen"></td>
                      <td class="px-3 py-2" id="rep-pct-usd-pen"></td>
                      <td class="px-3 py-2"></td>
                      <td class="px-3 py-2">%</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>

            <div class="p-5 bg-white rounded-xl shadow-lg border border-gray-200">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-[16px] leading-none font-semibold text-gray-900 flex items-center gap-2"><i class="fas fa-tags text-emerald-600"></i> Venta por tipo</h3>
              </div>
              <div class="overflow-auto">
                <table id="rep-tabla-venta-tipo" class="min-w-full text-gray-700">
                  <thead class="bg-gray-50 text-gray-600 font-semibold"><tr><th class="px-3 py-2 text-left">Tipo</th><th class="px-3 py-2 text-right">Venta PEN</th><th class="px-3 py-2 text-right">SUBTOTAL</th></tr></thead>
                  <tbody class="divide-y divide-gray-100">
                    <tr><th class="px-3 py-2 text-left">TIENDA DE VINOS</th><td class="px-3 py-2 text-right whitespace-nowrap" id="rep-tienda-venta">--</td><td class="px-3 py-2 text-right whitespace-nowrap" id="rep-tienda-subtotal">--</td></tr>
                    <tr><th class="px-3 py-2 text-left">PROPINAS</th><td class="px-3 py-2 text-right whitespace-nowrap" id="rep-propinas-venta">--</td><td class="px-3 py-2 text-right whitespace-nowrap" id="rep-propinas-subtotal">--</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="p-5 bg-white rounded-xl shadow-lg border border-gray-200">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-[16px] leading-none font-semibold text-gray-900 flex items-center gap-2"><i class="fas fa-users text-emerald-600"></i> Venta por cliente</h3>
              </div>
              <div class="overflow-auto">
                <table id="rep-tabla-venta-cliente" class="min-w-full text-gray-700">
                  <thead class="bg-gray-50 text-gray-600 font-semibold"><tr><th class="px-3 py-2 text-left">CLIENTES</th><th class="px-3 py-2 text-right">TOTAL PEN</th><th class="px-3 py-2 text-right">%</th></tr></thead>
                  <tbody class="divide-y divide-gray-100">
                    <tr><th class="px-3 py-2 text-left">VARIOS</th><td class="px-3 py-2 text-right whitespace-nowrap" id="rep-varios-total">--</td><td class="px-3 py-2 text-right" id="rep-varios-porcentaje">--</td></tr>
                    <tr><th class="px-3 py-2 text-left">SANTIAGO QUEIROLO SAC</th><td class="px-3 py-2 text-right whitespace-nowrap" id="rep-queirolo-total">--</td><td class="px-3 py-2 text-right" id="rep-queirolo-porcentaje">--</td></tr>
                    <tr class="bg-gray-50 font-semibold text-gray-900"><th class="px-3 py-2 text-left">TOTAL</th><td class="px-3 py-2 text-right whitespace-nowrap" id="rep-cliente-total">--</td><td class="px-3 py-2 text-right">100%</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="p-5 bg-white rounded-xl shadow-lg border border-gray-200 mt-6">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-[16px] leading-none font-semibold text-gray-900 flex items-center gap-2"><i class="fas fa-chart-line text-emerald-600"></i> ProducciÃ³n y Ocupabilidad</h3>
            </div>
            <div class="overflow-auto">
              <table id="rep-tabla-produccion" class="min-w-full text-gray-700">
                <thead class="bg-gray-50 text-gray-600 font-semibold">
                  <tr><th class="px-3 py-2 text-left">Concepto</th><th class="px-3 py-2 text-right">Con Impuesto</th><th class="px-3 py-2 text-right">Sin Impuesto</th><th class="px-3 py-2 text-right">Ocupabilidad %</th></tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                  <tr><th class="px-3 py-2 text-left font-medium">ProducciÃ³n</th><td class="px-3 py-2 text-right" id="rep-produccion-cimp">--</td><td class="px-3 py-2 text-right" id="rep-produccion-simp">--</td><td class="px-3 py-2 text-right" id="rep-ocupabilidad">--</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>`;
    }

    function createReportTableRows() {
      const bodyVentas = document.getElementById('rep-ventas-body');
      const bodyResumen = document.getElementById('rep-resumen-body');
      if (!bodyVentas || !bodyResumen) return;

      bodyVentas.innerHTML = '';
      bodyResumen.innerHTML = '';

      const dates = Array.isArray(weekIsoDates) ? weekIsoDates : [];
      const maxRows = 7;

      for (let i = 0; i < maxRows; i++) {
        const dateISO = i < dates.length ? dates[i] : `placeholder-${i}`;
        const parts = dateISO.includes('-') ? dateISO.split('-') : null;
        const formattedDate = parts ? `${parts[2]}/${parts[1]}/${parts[0]}` : '--/--/----';

        const trVentas = document.createElement('tr');
        trVentas.dataset.date = dateISO;
        let cellsVentas = `<th class="px-3 py-2 text-left font-medium">${formattedDate}</th>`;
        for (let j = 0; j < 15; j++) cellsVentas += `<td class="px-3 py-2 text-right">0.00</td>`;
        cellsVentas += `<td class="px-3 py-2 text-right font-semibold">0.00</td>`;
        trVentas.innerHTML = cellsVentas;
        bodyVentas.appendChild(trVentas);

        const trResumen = document.createElement('tr');
        trResumen.dataset.date = dateISO;
        trResumen.innerHTML = `
          <th class="px-3 py-2 text-left font-medium">${formattedDate}</th>
          <td class="px-3 py-2 text-right">0.00</td>
          <td class="px-3 py-2 text-right">0.00</td>
          <td class="px-3 py-2 text-right">0.00</td>
          <td class="px-3 py-2 text-right">0.00</td>
          <td class="px-3 py-2 text-right">0.0000</td>
        `;
        bodyResumen.appendChild(trResumen);
      }
    }

    function mapExtractedDataToHtmlTable() {
      const tbody = document.getElementById('rep-tabla-ventas')?.querySelector('tbody');
      if (!tbody || extractedReportData.length < 2) return;

      const htmlHeaders = Array.from(document.querySelectorAll('#rep-tabla-ventas thead th')).map(th => th.textContent.trim());
      const excelHeaders = extractedReportData[0].map(h => String(h || '').trim());
      const headerMap = new Map();

      htmlHeaders.forEach((htmlHeader, htmlIndex) => {
        let excelIndex = htmlHeader === 'Fecha' ? excelHeaders.indexOf('Secc.') : excelHeaders.indexOf(htmlHeader);
        if (excelIndex !== -1) headerMap.set(htmlIndex, excelIndex);
      });

      const reportDataMap = new Map();
      for (let i = 1; i < extractedReportData.length; i++) {
        const row = extractedReportData[i];
        const dateValue = row[0];
        if (dateValue instanceof Date && !isNaN(dateValue.getTime())) {
          reportDataMap.set(formatDate(dateValue, 'DD/MM/YYYY'), row);
        }
      }

      const htmlRows = tbody.querySelectorAll('tr[data-date]');
      const usdColumns = ["DEPOSITO DOLARES", "EFECTIVO DOLARES", "TARJETA DOLARES AMEX-DOL", "TARJETA DOLARES DC-DOL", "TARJETA DOLARES MC-DOL", "TARJETA DOLARES VISA-DOL", "TRANSFER. DOLARES"];
      const valoresUsdPorDia = {};
      let totalGeneralPen = 0;

      htmlRows.forEach(htmlRow => {
        const htmlDateISO = htmlRow.dataset.date;
        if (htmlDateISO && !htmlDateISO.startsWith("placeholder")) {
          const parts = htmlDateISO.split('-');
          const dateKey = `${parts[2]}/${parts[1]}/${parts[0]}`;
          const excelDayData = reportDataMap.get(dateKey);
          const exchangeRate = exchangeRates[dateKey] || 0;

          if (excelDayData) {
            valoresUsdPorDia[htmlDateISO] = {};
            const htmlCells = htmlRow.querySelectorAll('td');
            htmlCells.forEach((htmlCell, htmlCellIndex) => {
              const htmlHeaderIndex = htmlCellIndex + 1;
              if (headerMap.has(htmlHeaderIndex)) {
                const excelRawValue = excelDayData[headerMap.get(htmlHeaderIndex)];
                const numericValue = convertToNumber(excelRawValue);
                htmlCell.textContent = formatNumber(numericValue);
                if (usdColumns.includes(htmlHeaders[htmlHeaderIndex]) && exchangeRate > 0) {
                  valoresUsdPorDia[htmlDateISO][htmlHeaders[htmlHeaderIndex]] = numericValue;
                }
              }
            });
            const totalCell = htmlRow.cells[htmlRow.cells.length - 1];
            const totalDelExcel = convertToNumber(excelDayData[excelHeaders.indexOf('Total')]);
            if (totalCell) totalCell.textContent = formatNumber(totalDelExcel, 2, true);
            totalGeneralPen += totalDelExcel;
          }
        }
      });

      // Total PEN Row
      const totalPenRowHtml = document.getElementById('rep-totals-pen-row');
      if (totalPenRowHtml && extractedReportData.length > 1) {
        const totalPenData = extractedReportData[extractedReportData.length - 1];
        const htmlCells = totalPenRowHtml.querySelectorAll('td');
        for (let i = 0; i < htmlCells.length - 1; i++) {
          if (headerMap.has(i + 1)) {
            htmlCells[i].textContent = formatNumber(convertToNumber(totalPenData[headerMap.get(i + 1)]));
          }
        }
        const lastCell = htmlCells[htmlCells.length - 1];
        const excelTotalValue = totalPenData[excelHeaders.indexOf('Total')];
        lastCell.textContent = "S/ " + formatNumber(convertToNumber(excelTotalValue), 2, true);
      }

      // Total USD Row
      const totalUsdRowHtml = document.getElementById('rep-totals-usd-row');
      if (totalUsdRowHtml) {
        const totalUsdPorColumna = {};
        usdColumns.forEach(h => totalUsdPorColumna[h] = 0);
        Object.keys(valoresUsdPorDia).forEach(dateISO => {
          const parts = dateISO.split('-');
          const dateKey = `${parts[2]}/${parts[1]}/${parts[0]}`;
          const rate = exchangeRates[dateKey] || 0;
          if (rate > 0) {
            Object.keys(valoresUsdPorDia[dateISO]).forEach(header => {
              totalUsdPorColumna[header] += (valoresUsdPorDia[dateISO][header] / rate);
            });
          }
        });

        let totalGeneralUsd = 0;
        const htmlCells = totalUsdRowHtml.querySelectorAll('td');
        htmlCells.forEach((cell, idx) => {
          const header = htmlHeaders[idx + 1];
          if (usdColumns.includes(header)) {
            const val = totalUsdPorColumna[header];
            cell.textContent = formatNumber(val, 2, true);
            totalGeneralUsd += val;
          } else if (header !== 'Total') cell.textContent = '--';
        });
        const lastUsdCell = htmlCells[htmlCells.length - 1];
        if (lastUsdCell) lastUsdCell.textContent = "$ " + formatNumber(totalGeneralUsd, 2, true);
      }

      updateResumenVentasTable();
      setTimeout(() => updateVentasPorTipoTable(totalGeneralPen), 0);
    }

    function updateResumenVentasTable() {
      const tbody = document.getElementById('rep-resumen-body');
      const tbodyVentas = document.getElementById('rep-ventas-body');
      if (!tbody || !tbodyVentas) return;

      const ventasHeaders = Array.from(document.querySelectorAll('#rep-tabla-ventas thead th')).map(th => th.textContent.trim());
      const penColumns = ["CREDITO", "DEPOSITO SOLES", "EFECTIVO SOLES", "TARJETA SOLES AMEX-SOL", "TARJETA SOLES DC-SOL", "TARJETA SOLES MC-SOL", "TARJETA SOLES VISA-SOL", "TRANSFER. SOLES"];
      const usdColumns = ["DEPOSITO DOLARES", "EFECTIVO DOLARES", "TARJETA DOLARES AMEX-DOL", "TARJETA DOLARES DC-DOL", "TARJETA DOLARES MC-DOL", "TARJETA DOLARES VISA-DOL", "TRANSFER. DOLARES"];

      let totalGenPEN = 0, totalGenOnlyPEN = 0, totalGenUSDenPEN = 0, totalGenUSD = 0;
      const rowsVentas = tbodyVentas.querySelectorAll('tr[data-date]');

      rowsVentas.forEach(rowVenta => {
        const dateISO = rowVenta.dataset.date;
        if (!dateISO || dateISO.startsWith('placeholder')) return;

        const rowResumen = tbody.querySelector(`tr[data-date="${dateISO}"]`);
        if (!rowResumen) return;

        const parts = dateISO.split('-');
        const dateKey = `${parts[2]}/${parts[1]}/${parts[0]}`;
        const exchangeRate = exchangeRates[dateKey] || 0;
        if (exchangeRate <= 0) return;

        const totalPENValue = convertToNumber(rowVenta.cells[rowVenta.cells.length - 1].textContent);
        if (rowResumen.cells[1]) rowResumen.cells[1].textContent = formatNumber(totalPENValue, 2, true);
        totalGenPEN += totalPENValue;

        let totalPEN = 0, totalUSDenPEN = 0;
        Array.from(rowVenta.cells).forEach((cell, idx) => {
          if (idx === 0 || idx === rowVenta.cells.length - 1) return;
          const header = ventasHeaders[idx];
          const val = convertToNumber(cell.textContent);
          if (penColumns.some(c => header.includes(c))) totalPEN += val;
          else if (usdColumns.some(c => header.includes(c))) totalUSDenPEN += val;
        });

        if (rowResumen.cells[2]) rowResumen.cells[2].textContent = formatNumber(totalPEN, 2, true);
        if (rowResumen.cells[3]) rowResumen.cells[3].textContent = formatNumber(totalUSDenPEN, 2, true);

        const totalUSD = totalUSDenPEN / exchangeRate;
        if (rowResumen.cells[4]) rowResumen.cells[4].textContent = formatNumber(totalUSD, 2, true);
        if (rowResumen.cells[5]) rowResumen.cells[5].textContent = formatNumber(exchangeRate, 4, false);

        totalGenOnlyPEN += totalPEN;
        totalGenUSDenPEN += totalUSDenPEN;
        totalGenUSD += totalUSD;
      });

      document.getElementById('rep-total-pen').textContent = formatNumber(totalGenPEN, 2, true);
      document.getElementById('rep-total-only-pen').textContent = formatNumber(totalGenOnlyPEN, 2, true);
      document.getElementById('rep-total-usd-pen').textContent = formatNumber(totalGenUSDenPEN, 2, true);
      document.getElementById('rep-total-usd').textContent = formatNumber(totalGenUSD, 2, true);

      if (totalGenPEN > 0) {
        document.getElementById('rep-pct-pen').textContent = formatNumber((totalGenOnlyPEN / totalGenPEN) * 100, 1, false) + '%';
        document.getElementById('rep-pct-usd-pen').textContent = formatNumber((totalGenUSDenPEN / totalGenPEN) * 100, 1, false) + '%';
      }
    }

    function updateVentasPorTipoTable(totalVentasPEN = 0) {
      const propinasVentaValor = convertToNumber(propinasTotal);
      const tiendaTotal = convertToNumber(tiendaVentaTotal);
      const variosTotal = Math.max(totalVentasPEN - (queiroloTotal || 0), 0);

      document.getElementById('rep-tienda-venta').textContent = `S/ ${formatNumber(tiendaTotal, 2, true)}`;
      document.getElementById('rep-tienda-subtotal').textContent = `S/ ${formatNumber(totalVentasPEN - tiendaTotal, 2, true)}`;
      document.getElementById('rep-propinas-venta').textContent = `S/ ${formatNumber(propinasVentaValor, 2, true)}`;
      document.getElementById('rep-propinas-subtotal').textContent = `S/ ${formatNumber(totalVentasPEN - propinasVentaValor, 2, true)}`;

      document.getElementById('rep-queirolo-total').textContent = `S/ ${formatNumber(Number(queiroloTotal || 0))}`;
      document.getElementById('rep-varios-total').textContent = `S/ ${formatNumber(variosTotal)}`;
      document.getElementById('rep-cliente-total').textContent = `S/ ${formatNumber(totalVentasPEN)}`;

      const qPct = totalVentasPEN > 0 ? (Number(queiroloTotal || 0) / totalVentasPEN) * 100 : 0;
      const vPct = totalVentasPEN > 0 ? (variosTotal / totalVentasPEN) * 100 : 0;
      document.getElementById('rep-queirolo-porcentaje').textContent = `${formatNumber(qPct, 2)}%`;
      document.getElementById('rep-varios-porcentaje').textContent = `${formatNumber(vPct, 2)}%`;

      document.getElementById('rep-produccion-cimp').textContent = `S/ ${formatNumber(produccionConImp || 0, 2, false)}`;
      document.getElementById('rep-produccion-simp').textContent = `S/ ${formatNumber(produccionSinImp || 0, 2, false)}`;
      document.getElementById('rep-ocupabilidad').textContent = `${formatNumber(ocupabilidad || 0, 1, false)}%`;
    }

    function openReportModal() {
      const container = document.getElementById('report-content');
      if (container) {
        container.innerHTML = buildReplicatedReportHTML();
        createReportTableRows();
        setTimeout(() => mapExtractedDataToHtmlTable(), 100);
        document.getElementById('report-modal').classList.remove('hidden');

        const downloadBtn = document.getElementById('download-pdf-btn');
        if (downloadBtn) downloadBtn.addEventListener('click', generatePDF);
      }
    }

    function closeReportModal() {
      document.getElementById('report-modal').classList.add('hidden');
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      let startY = 15;

      // Colores corporativos (Azul oscuro profesional)
      const colors = {
        headerFill: [41, 58, 74], // #293a4a
        headerText: [255, 255, 255],
        zebraFill: [248, 249, 250], // #f8f9fa
        totalFill: [226, 232, 240], // #e2e8f0
        totalText: [30, 41, 59], // #1e293b
        accent: [59, 130, 246] // #3b82f6 (Blue 500)
      };

      // TÃ­tulo del reporte
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(16);
      pdf.setTextColor(30, 41, 59);
      pdf.text(`Reporte de Ventas`, pageWidth / 2, 10, { align: 'center' });

      pdf.setFontSize(11);
      pdf.setFont('helvetica', 'normal');
      pdf.setTextColor(100, 116, 139);
      pdf.text(`${selectedPeriod.weekText || ''} ${selectedPeriod.year || ''}`, pageWidth / 2, 16, { align: 'center' });

      // 1. Tabla Principal
      startY = 22;
      pdf.setFontSize(10);
      pdf.setTextColor(30, 41, 59);
      pdf.setFont('helvetica', 'bold');
      pdf.text("Resumen de venta por dÃ­a", 14, startY);
      startY += 3;

      pdf.autoTable({
        html: '#rep-tabla-ventas',
        startY: startY,
        theme: 'grid',
        styles: {
          cellPadding: 1.5,
          lineColor: [203, 213, 225],
          lineWidth: 0.1,
          font: 'helvetica',
          fontSize: 6.5,
          textColor: [51, 65, 85]
        },
        headStyles: {
          fillColor: colors.headerFill,
          textColor: colors.headerText,
          fontStyle: 'bold',
          fontSize: 6,
          halign: 'center',
          valign: 'middle'
        },
        bodyStyles: {
          valign: 'middle'
        },
        alternateRowStyles: {
          fillColor: colors.zebraFill
        },
        footStyles: {
          fillColor: colors.totalFill,
          textColor: colors.totalText,
          fontStyle: 'bold',
          fontSize: 7,
          halign: 'right'
        },
        columnStyles: {
          0: { cellWidth: 16, halign: 'left', fontStyle: 'bold' }, // Fecha
          16: { cellWidth: 20, halign: 'right', fontStyle: 'bold' } // Total
        },
        didParseCell: function (data) {
          // Alinear columnas numÃ©ricas a la derecha
          if (data.section === 'body' && data.column.index > 0) {
            data.cell.styles.halign = 'right';
          }
          // Estilo especial para filas de totales en el cuerpo si las hubiera
          if (data.row.raw && String(data.row.raw[0]).includes('TOTAL')) {
            data.cell.styles.fontStyle = 'bold';
            data.cell.styles.fillColor = colors.totalFill;
          }
        }
      });

      startY = pdf.lastAutoTable.finalY + 10;

      // Layout para tablas inferiores (3 columnas)
      const bottomTableY = startY;
      const margin = 14;
      const gap = 8;
      const availableWidth = pageWidth - (margin * 2);

      // Calculamos anchos: Resumen (40%), Tipo (30%), Cliente (30%)
      const widthResumen = (availableWidth * 0.40) - gap;
      const widthTipo = (availableWidth * 0.30) - gap;
      const widthCliente = (availableWidth * 0.30);

      // Estilos comunes para tablas pequeÃ±as
      const smallTableStyles = {
        theme: 'grid',
        styles: { fontSize: 7, cellPadding: 2, lineColor: [203, 213, 225], lineWidth: 0.1 },
        headStyles: { fillColor: colors.headerFill, textColor: colors.headerText, fontStyle: 'bold', halign: 'left' },
        footStyles: { fillColor: colors.totalFill, textColor: colors.totalText, fontStyle: 'bold' },
        alternateRowStyles: { fillColor: colors.zebraFill }
      };

      // 2. Resumen Total
      pdf.setFontSize(10);
      pdf.setTextColor(30, 41, 59);
      pdf.text("Resumen de venta total", margin, bottomTableY);

      pdf.autoTable({
        html: '#rep-tabla-resumen',
        startY: bottomTableY + 4,
        margin: { left: margin },
        tableWidth: widthResumen,
        ...smallTableStyles,
        columnStyles: {
          0: { cellWidth: 20, fontStyle: 'bold' }, // Label
          1: { halign: 'right' }, // Valor
          2: { halign: 'right' }, // Valor
          3: { halign: 'right' }, // Valor
          4: { halign: 'center' } // TC
        }
      });
      let yResumenEnd = pdf.lastAutoTable.finalY;

      // 3. Venta por Tipo
      const xTipo = margin + widthResumen + gap;
      pdf.text("Venta por tipo", xTipo, bottomTableY);

      pdf.autoTable({
        html: '#rep-tabla-venta-tipo',
        startY: bottomTableY + 4,
        margin: { left: xTipo },
        tableWidth: widthTipo,
        ...smallTableStyles,
        columnStyles: {
          1: { halign: 'right' },
          2: { halign: 'right' }
        }
      });
      let yTipoEnd = pdf.lastAutoTable.finalY;

      // 4. Venta por Cliente
      const xCliente = xTipo + widthTipo + gap;
      pdf.text("Venta por cliente", xCliente, bottomTableY);

      pdf.autoTable({
        html: '#rep-tabla-venta-cliente',
        startY: bottomTableY + 4,
        margin: { left: xCliente },
        tableWidth: widthCliente,
        ...smallTableStyles,
        columnStyles: {
          1: { halign: 'right' },
          2: { halign: 'right' }
        }
      });
      let yClienteEnd = pdf.lastAutoTable.finalY;

      // 5. ProducciÃ³n (Ubicada debajo de las tablas derechas para aprovechar el espacio)
      // Calculamos la posiciÃ³n Y basada en las tablas de la derecha
      let startYProduccion = Math.max(yTipoEnd, yClienteEnd) + 10;

      // Si por alguna razÃ³n la tabla de resumen es MUY larga y choca, ajustamos (opcional, pero seguro)
      // En este caso queremos llenar el hueco, asÃ­ que confiamos en que hay espacio.

      // Ancho combinado de las dos tablas de la derecha
      const widthProduccion = widthTipo + gap + widthCliente;

      // Verificar si cabe en la pÃ¡gina, si no, nueva pÃ¡gina
      if (startYProduccion + 30 > pageHeight) {
        pdf.addPage();
        startYProduccion = 15;
      }

      pdf.text("ProducciÃ³n y Ocupabilidad", xTipo, startYProduccion);
      pdf.autoTable({
        html: '#rep-tabla-produccion',
        startY: startYProduccion + 4,
        theme: 'grid',
        styles: { fontSize: 8, cellPadding: 3, lineColor: [203, 213, 225], lineWidth: 0.1 },
        headStyles: { fillColor: colors.headerFill, textColor: colors.headerText, fontStyle: 'bold' },
        margin: { left: xTipo }, // Alineado con la columna derecha
        tableWidth: widthProduccion,
        columnStyles: {
          1: { halign: 'right' },
          2: { halign: 'right' },
          3: { halign: 'center' }
        }
      });

      // Pie de pÃ¡gina
      const pageCount = pdf.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        pdf.setPage(i);
        pdf.setFontSize(8);
        pdf.setTextColor(150);
        pdf.text(`PÃ¡gina ${i} de ${pageCount} - Generado el ${new Date().toLocaleDateString()}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
      }

      pdf.save(`Reporte_Ventas_${selectedPeriod.year}_${selectedPeriod.week || 'Semana'}.pdf`);
    }

    async function readExcelFile(file, options = { returnWorksheet: false }) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            if (options.returnWorksheet) resolve(worksheet);
            else resolve(XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true, defval: '' }));
          } catch (error) { reject(error); }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    const readXlsxAsArray = (file) => readExcelFile(file, { returnWorksheet: false });

    // Helpers de conversiÃ³n
    function excelDateToJSDate(serial) {
      const utcDate = new Date((serial - 25569) * 86400 * 1000);
      const timezoneOffset = utcDate.getTimezoneOffset() * 60000;
      return new Date(utcDate.getTime() + timezoneOffset);
    }

    function convertToDate(value) {
      if (value instanceof Date && !isNaN(value.getTime())) return value;
      if (typeof value === 'number') return excelDateToJSDate(value);
      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(trimmed)) {
          const p = trimmed.split('/');
          return new Date(parseInt(p[2]), parseInt(p[1]) - 1, parseInt(p[0]));
        }
        if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
          const p = trimmed.split('-');
          return new Date(parseInt(p[0]), parseInt(p[1]) - 1, parseInt(p[2]));
        }
      }
      return null;
    }

    function convertToNumber(value) {
      if (typeof value === 'number') return value;
      if (typeof value === 'string') {
        let clean = value.replace(/[, ](?=\d{3})/g, '').replace(',', '.').replace(/[^\d.\-]/g, '');
        const num = parseFloat(clean);
        return isNaN(num) ? 0 : num;
      }
      return 0;
    }

    function formatNumber(num, decimals = 2, forceInteger = false) {
      const val = Number(num);
      if (isNaN(val)) return Number(0).toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
      return val.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }



  </script>
</body>

</html>